<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>博幼圖書館管理系統</title>
    <link rel="stylesheet" href="styles.css">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        /* 新增書籍表單樣式 */
        .form-help {
            display: block;
            margin-top: 5px;
            color: #718096;
            font-size: 0.85rem;
            line-height: 1.4;
        }
        
        .form-help i {
            margin-right: 5px;
            color: #667eea;
        }
        
        .form-actions {
            display: flex;
            gap: 15px;
            justify-content: flex-end;
            margin-top: 25px;
            padding-top: 20px;
            border-top: 1px solid #e2e8f0;
        }
        
        .form-group label {
            display: flex;
            align-items: center;
            gap: 8px;
            font-weight: 600;
            color: #4a5568;
            margin-bottom: 8px;
        }
        
        .form-group label i {
            color: #667eea;
            width: 16px;
        }
        
        .form-group input {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-size: 1rem;
            transition: all 0.3s ease;
        }
        
        .form-group input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
        
        .form-group input:invalid {
            border-color: #f56565;
        }
        
        .field-error {
            color: #f56565;
            font-size: 0.8rem;
            margin-top: 5px;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .field-error::before {
            content: "⚠️";
            font-size: 0.7rem;
        }
        
        /* 模態框標題樣式 */
        .modal-content h2 {
            display: flex;
            align-items: center;
            gap: 10px;
            color: #4a5568;
            margin-bottom: 25px;
        }
        
        .modal-content h2 i {
            color: #667eea;
        }
        
        /* 響應式設計 */
        @media (max-width: 768px) {
            .form-actions {
                flex-direction: column;
            }
            
            .form-actions .btn {
                width: 100%;
            }
        }

        /* 設定標籤頁樣式 */
        .settings-tabs {
            display: flex;
            border-bottom: 2px solid #e2e8f0;
            margin-bottom: 20px;
        }

        .tab-btn {
            background: none;
            border: none;
            padding: 12px 20px;
            cursor: pointer;
            border-bottom: 3px solid transparent;
            transition: all 0.3s ease;
            color: #718096;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .tab-btn:hover {
            color: #4a5568;
            background: #f7fafc;
        }

        .tab-btn.active {
            color: #667eea;
            border-bottom-color: #667eea;
            background: #f7fafc;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        /* 使用者借閱管理樣式 */
        .user-loan-management {
            max-height: 500px;
            overflow-y: auto;
        }

        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 1px solid #e2e8f0;
        }

        .section-header h3 {
            color: #4a5568;
            margin: 0;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .search-section {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }

        .search-section input {
            flex: 1;
            padding: 10px;
            border: 1px solid #e2e8f0;
            border-radius: 6px;
        }

        .user-loan-item {
            display: flex;
            align-items: center;
            padding: 15px;
            margin-bottom: 10px;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            background: white;
            transition: all 0.3s ease;
        }

        .user-loan-item:hover {
            border-color: #667eea;
            box-shadow: 0 2px 8px rgba(102, 126, 234, 0.1);
        }

        .user-loan-info {
            flex: 1;
        }

        .user-loan-username {
            font-weight: 600;
            color: #2d3748;
            margin-bottom: 5px;
        }

        .user-loan-details {
            font-size: 0.9rem;
            color: #718096;
        }

        .user-loan-days {
            font-size: 1.1rem;
            font-weight: 600;
            color: #667eea;
            margin-right: 15px;
        }

        .user-loan-actions {
            display: flex;
            gap: 8px;
        }

        .user-loan-actions .btn {
            padding: 6px 12px;
            font-size: 0.85rem;
        }

        .empty-user-loan-list {
            text-align: center;
            color: #718096;
            padding: 40px 20px;
            font-style: italic;
        }

        /* 借閱者管理樣式 */
        .borrowers-management {
            max-height: 600px;
            overflow-y: auto;
        }

        .borrowers-stats {
            color: #667eea;
            font-weight: 600;
        }

        .borrower-item {
            display: flex;
            align-items: center;
            padding: 15px;
            margin-bottom: 10px;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            background: white;
            transition: all 0.3s ease;
        }

        .borrower-item:hover {
            border-color: #667eea;
            box-shadow: 0 2px 8px rgba(102, 126, 234, 0.1);
        }

        .borrower-item.overdue {
            border-color: #f56565;
            background: #fff5f5;
        }

        .borrower-info {
            flex: 1;
        }

        .borrower-name {
            font-weight: 600;
            color: #2d3748;
            margin-bottom: 5px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .borrower-details {
            font-size: 0.9rem;
            color: #718096;
            line-height: 1.4;
        }

        .borrower-books {
            margin-top: 8px;
            font-size: 0.85rem;
            color: #4a5568;
        }

        .borrower-book-item {
            padding: 4px 8px;
            margin: 2px 0;
            background: #f7fafc;
            border-radius: 4px;
            border-left: 3px solid #667eea;
        }

        .borrower-book-item.overdue {
            border-left-color: #f56565;
            background: #fff5f5;
        }

        .borrower-status {
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            margin-right: 15px;
            min-width: 80px;
        }

        .borrower-status-badge {
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 600;
            text-align: center;
            margin-bottom: 5px;
        }

        .borrower-status-badge.normal {
            background: #c6f6d5;
            color: #22543d;
        }

        .borrower-status-badge.overdue {
            background: #fed7d7;
            color: #742a2a;
        }

        .borrower-actions {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .borrower-actions .btn {
            padding: 4px 8px;
            font-size: 0.75rem;
            white-space: nowrap;
        }

        .empty-borrowers-list {
            text-align: center;
            color: #718096;
            padding: 40px 20px;
            font-style: italic;
        }

        /* 身分審核管理樣式 */
        .approval-management {
            max-height: 600px;
            overflow-y: auto;
        }

        .approval-stats {
            color: #667eea;
            font-weight: 600;
        }

        .application-item {
            display: flex;
            align-items: center;
            padding: 15px;
            margin-bottom: 10px;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            background: white;
            transition: all 0.3s ease;
        }

        .application-item:hover {
            border-color: #667eea;
            box-shadow: 0 2px 8px rgba(102, 126, 234, 0.1);
        }

        .application-item.urgent {
            border-color: #f56565;
            background: #fff5f5;
        }

        .application-info {
            flex: 1;
        }

        .applicant-name {
            font-weight: 600;
            color: #2d3748;
            margin-bottom: 5px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .application-details {
            font-size: 0.9rem;
            color: #718096;
            line-height: 1.4;
        }

        .application-status {
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            margin-right: 15px;
            min-width: 100px;
        }

        .application-status-badge {
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 600;
            text-align: center;
            margin-bottom: 5px;
        }

        .application-status-badge.pending {
            background: #fed7d7;
            color: #742a2a;
        }

        .application-status-badge.approved {
            background: #c6f6d5;
            color: #22543d;
        }

        .application-status-badge.rejected {
            background: #e2e8f0;
            color: #4a5568;
        }

        .application-actions {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .application-actions .btn {
            padding: 4px 8px;
            font-size: 0.75rem;
            white-space: nowrap;
        }

        .empty-applications-list {
            text-align: center;
            color: #718096;
            padding: 40px 20px;
            font-style: italic;
        }

        .application-timeline {
            margin-top: 10px;
            font-size: 0.85rem;
            color: #4a5568;
        }

        .timeline-item {
            display: flex;
            align-items: center;
            margin: 3px 0;
            padding: 2px 0;
        }

        .timeline-dot {
            width: 6px;
            height: 6px;
            border-radius: 50%;
            margin-right: 8px;
            background: #cbd5e0;
        }

        .timeline-dot.submitted {
            background: #667eea;
        }

        .timeline-dot.reviewed {
            background: #48bb78;
        }

        .timeline-dot.rejected {
            background: #f56565;
        }

        /* 刪除身分管理樣式 */
        .delete-identity-management {
            max-height: 600px;
            overflow-y: auto;
        }

        .identity-stats {
            color: #dc3545;
            font-weight: 600;
        }

        .identity-item {
            display: flex;
            align-items: center;
            padding: 15px;
            margin-bottom: 10px;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            background: white;
            transition: all 0.3s ease;
        }

        .identity-item:hover {
            border-color: #dc3545;
            box-shadow: 0 2px 8px rgba(220, 53, 69, 0.1);
        }

        .identity-info {
            flex: 1;
        }

        .identity-name {
            font-weight: 600;
            color: #2d3748;
            margin-bottom: 5px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .identity-details {
            font-size: 0.9rem;
            color: #718096;
            line-height: 1.4;
        }

        .identity-role {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 0.8rem;
            font-weight: 600;
            margin-left: 8px;
        }

        .identity-role.student {
            background: #e3f2fd;
            color: #1565c0;
        }

        .identity-role.staff {
            background: #f3e5f5;
            color: #7b1fa2;
        }

        .identity-role.admin {
            background: #ffebee;
            color: #c62828;
        }

        .identity-actions {
            display: flex;
            gap: 8px;
            align-items: center;
        }

        .identity-actions .btn {
            padding: 6px 12px;
            font-size: 0.85rem;
        }

        .identity-borrow-count {
            background: #f8f9fa;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.8rem;
            color: #6c757d;
            margin-right: 8px;
        }

    </style>
</head>
<body>
    <div class="container">
        <!-- 標題區域 -->
        <header class="header">
            <h1><i class="fas fa-book"></i> 博幼圖書館管理系統</h1>
            <div class="user-info">
                <span id="current-user">訪客</span>
                <button id="login-btn" class="btn btn-outline">登入</button>
                <button id="logout-btn" class="btn btn-outline" style="display: none;">登出</button>
            </div>
        </header>

        <!-- 控制面板 -->
        <div class="control-panel">
            <div class="search-section">
                <div class="search-bar">
                    <input type="text" id="search-input" placeholder="搜尋書名、書碼、年份、類別...">
                    <button id="search-btn" class="btn btn-primary">
                        <i class="fas fa-search"></i>
                    </button>
                </div>
                <div class="quick-borrow-row">
                    <span class="quick-borrow-label"><i class="fas fa-barcode"></i> 快速借閱</span>
                    <div class="quick-borrow-input">
                        <input type="text" id="borrow-by-code-input" placeholder="輸入書碼（例：C0001）">
                        <button id="borrow-by-code-btn" class="btn btn-warning">
                            <i class="fas fa-book-reader"></i> 借閱
                        </button>
                    </div>
                </div>
                <div class="filter-section">
                    <select id="genre-filter">
                        <option value="">全部類別</option>
                        <option value="繪本">繪本 (A)</option>
                        <option value="橋梁書">橋梁書 (B)</option>
                        <option value="文字書">文字書 (C)</option>
                    </select>
                    <div class="genre-legend">
                        <span class="legend-item">
                            <span class="legend-color" style="background: #ff6b6b;"></span>
                            繪本 (A)
                        </span>
                        <span class="legend-item">
                            <span class="legend-color" style="background: #f39c12;"></span>
                            橋梁書 (B)
                        </span>
                        <span class="legend-item">
                            <span class="legend-color" style="background: #9b59b6;"></span>
                            文字書 (C)
                        </span>
                    </div>
                    <select id="sort-by">
                        <option value="title">按書名排序</option>
                        <option value="code">按書碼排序</option>
                        <option value="year">按年份排序</option>
                        <option value="genre">按類別排序</option>
                    </select>
                    <select id="sort-order">
                        <option value="asc">升冪</option>
                        <option value="desc">降冪</option>
                    </select>
                </div>
            </div>
            
            <div class="admin-section">
                <button id="boyou-books-btn" class="btn btn-primary">
                    <i class="fas fa-book-reader"></i> 博幼藏書
                </button>
                <button id="location-map-btn" class="btn btn-info">
                    <i class="fas fa-map"></i> 位置圖
                </button>
                <button id="staff-approval-btn" class="btn btn-warning" style="display: none;">
                    <i class="fas fa-user-check"></i> 身分審核
                </button>
                <button id="borrowers-list-btn" class="btn btn-warning" style="display: none;">
                    <i class="fas fa-users"></i> 借閱者清單
                </button>
                <button id="borrowers-sync-btn" class="btn btn-success" style="display: none;">
                    <i class="fas fa-cloud-upload-alt"></i> 借閱者上傳
                </button>
                <button id="delete-identity-btn" class="btn btn-danger" style="display: none;">
                    <i class="fas fa-user-times"></i> 刪除身分
                </button>
                <button id="settings-btn" class="btn btn-info">
                    <i class="fas fa-cog"></i> 系統設定
                </button>
                <button id="google-sync-btn" class="btn btn-success">
                    <i class="fas fa-cloud-upload-alt"></i> Google Sheets 同步
                </button>
                <button id="google-load-btn" class="btn btn-info">
                    <i class="fas fa-cloud-download-alt"></i> 從 Google Sheets 載入
                </button>
                <button id="import-btn" class="btn btn-success">
                    <i class="fas fa-file-import"></i> 匯入 Excel 書單
                </button>
                <input type="file" id="file-input" accept=".xlsx,.xls,.csv" style="display: none;">
                <button id="add-book-btn" class="btn btn-info">
                    <i class="fas fa-plus"></i> 新增館藏
                </button>
                <button id="fetch-all-covers-btn" class="btn btn-warning">
                    <i class="fas fa-images"></i> 一鍵搜尋封面
                </button>
                <button id="reload-csv-btn" class="btn btn-secondary">
                    <i class="fas fa-sync"></i> 重新載入資料
                </button>
                <button id="toggle-auto-update-btn" class="btn btn-success">
                    <i class="fas fa-sync-alt"></i> 自動更新
                </button>
                <button id="reset-btn" class="btn btn-warning">
                    <i class="fas fa-trash"></i> 重置資料
                </button>
            </div>
        </div>

        <!-- 統計資訊 -->
        <div class="stats-panel">
            <div class="stat-item">
                <span class="stat-number" id="total-books">0</span>
                <span class="stat-label">總館藏</span>
            </div>
            <div class="stat-item">
                <span class="stat-number" id="unique-titles">0</span>
                <span class="stat-label">不重複書名</span>
            </div>
            <div class="stat-item">
                <span class="stat-number" id="available-books">0</span>
                <span class="stat-label">可借閱</span>
            </div>
            <div class="stat-item">
                <span class="stat-number" id="borrowed-books">0</span>
                <span class="stat-label">已借出</span>
            </div>
        </div>


        <!-- 更新狀態 -->
        <div class="update-status-panel">
            <div class="update-info">
                <span id="last-update-time">最後更新：從未更新</span>
                <span id="auto-update-status" class="status-indicator">
                    <i class="fas fa-circle"></i> 自動更新已啟動
                </span>
            </div>
        </div>

        <!-- 書籍列表 -->
        <div class="books-section">
            <div class="books-header">
                <h2><i class="fas fa-book"></i> 館藏列表</h2>
                <div class="view-controls">
                    <button id="grid-view" class="view-btn active" title="網格視圖">
                        <i class="fas fa-th"></i>
                    </button>
                    <button id="list-view" class="view-btn" title="列表視圖">
                        <i class="fas fa-list"></i>
                    </button>
                </div>
            </div>
            <div id="books-container" class="books-grid">
                <!-- 書籍將在這裡動態生成 -->
            </div>
        </div>

        <button id="borrowed-fab" class="borrowed-fab" type="button" aria-label="借閱紀錄">
            <i class="fas fa-list"></i>
        </button>

        <button id="admin-fab" class="admin-fab" type="button" aria-label="管理">
            <i class="fas fa-sliders-h"></i>
        </button>

        <!-- 借閱記錄 -->
        <div class="borrowed-section">
            <div class="borrowed-header" role="button" tabindex="0" aria-label="切換借閱記錄顯示">
                <h2>借閱記錄
                    <button id="export-borrowed-btn" class="btn btn-success" style="margin-left: 10px;">
                        <i class="fas fa-file-excel"></i> 匯出 Excel
                    </button>
                </h2>
                <button id="borrowed-toggle-btn" class="borrowed-toggle-btn" type="button" aria-label="展開/收合借閱記錄">
                    <i class="fas fa-chevron-up"></i>
                </button>
            </div>
            
            <!-- 借閱記錄搜尋和篩選 -->
            <div class="borrowed-controls">
                <div class="borrowed-search">
                    <input type="text" id="borrowed-search-input" placeholder="搜尋書名、借閱者或書碼...">
                    <button class="btn btn-secondary" onclick="library.searchBorrowedBooks()">
                        <i class="fas fa-search"></i> 搜尋
                    </button>
                    <button class="btn btn-outline" onclick="library.clearBorrowedSearch()">
                        <i class="fas fa-times"></i> 清除
                    </button>
                </div>
                
                <div class="borrowed-filters">
                    <select id="borrowed-filter-status">
                        <option value="all">全部狀態</option>
                        <option value="borrowed">借閱中</option>
                        <option value="returned">已歸還</option>
                        <option value="overdue">逾期未還</option>
                    </select>
                    
                    <select id="borrowed-sort">
                        <option value="date-desc">借閱日期 (新到舊)</option>
                        <option value="date-asc">借閱日期 (舊到新)</option>
                        <option value="title">書名 (A-Z)</option>
                        <option value="borrower">借閱者 (A-Z)</option>
                        <option value="bookId">書碼</option>
                    </select>
                    
                    <button class="btn btn-warning" onclick="library.showOverdueBooks()">
                        <i class="fas fa-exclamation-triangle"></i> 逾期書籍
                    </button>
                    <button class="btn btn-info" onclick="library.showBorrowingStats()">
                        <i class="fas fa-chart-bar"></i> 借閱統計
                    </button>
                </div>
                
                <div class="borrowed-stats-summary">
                    <span id="borrowed-count-summary">總計: 0 本</span>
                    <span id="overdue-count-summary" style="color: #dc3545; margin-left: 15px;">逾期: 0 本</span>
                </div>
            </div>
            
            <div id="borrowed-container" class="borrowed-list">
                <!-- 借閱記錄將在這裡動態生成 -->
            </div>
        </div>
    </div>

    <div id="admin-actions-modal" class="modal actionsheet">
        <div class="modal-content actionsheet-content">
            <div class="actionsheet-handle" aria-hidden="true"></div>
            <div class="actionsheet-header">
                <div class="actionsheet-title">管理功能</div>
                <button id="admin-actions-close" class="actionsheet-close" type="button" aria-label="關閉">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div id="admin-actions-list" class="actionsheet-list"></div>
        </div>
    </div>

    <!-- 登入模態框 -->
    <div id="login-modal" class="modal">
        <div class="modal-content">
            <span class="close">&times;</span>
            <h2>登入系統</h2>
            
            <!-- 簡單登入模式（預設） -->
            <div id="simple-login-section">
                <form id="login-form">
                    <div class="form-group">
                        <label for="username">使用者名稱：</label>
                        <input type="text" id="username" required>
                        <small class="form-help">
                            <i class="fas fa-info-circle"></i>
                            請輸入您的使用者名稱，系統將自動識別您的身份
                        </small>
                    </div>
                    
                    <button type="submit" class="btn btn-primary">登入</button>
                </form>
            </div>
        </div>
    </div>

    <!-- 位置圖模態框 -->
    <div id="location-map-modal" class="modal">
        <div class="modal-content">
            <span class="close">&times;</span>
            <h2><i class="fas fa-map-marked-alt"></i> 博幼館藏位置圖</h2>
            <div style="text-align:center">
                <img id="location-map-img" src="BOYO館藏.jpg" alt="博幼館藏位置圖" style="max-width:100%;height:auto;border-radius:8px;" />
            </div>
        </div>
    </div>

    <!-- 新增書籍模態框 -->
    <div id="add-book-modal" class="modal">
        <div class="modal-content">
            <span class="close">&times;</span>
            <h2><i class="fas fa-plus-circle"></i> 新增館藏</h2>
            <form id="add-book-form">
                <div class="form-group">
                    <label for="book-prefix">
                        <i class="fas fa-tags"></i> 類別：
                    </label>
                    <select id="book-prefix" required>
                        <option value="A">A（繪本）</option>
                        <option value="B">B（橋梁書）</option>
                        <option value="C" selected>C（文字書）</option>
                    </select>
                    <small class="form-help">
                        <i class="fas fa-info-circle"></i>
                        選擇類別後會自動生成下一個可用書碼
                    </small>
                </div>
                <div class="form-group">
                    <label for="book-id">
                        <i class="fas fa-barcode"></i> 書碼：
                    </label>
                    <input type="text" id="book-id" placeholder="例：C0001" required>
                    <small class="form-help">
                        <i class="fas fa-info-circle"></i> 
                        書碼首字母決定類別：A=繪本, B=橋梁書, C=文字書
                    </small>
                </div>
                <div class="form-group">
                    <label for="book-title">
                        <i class="fas fa-book"></i> 書名：
                    </label>
                    <input type="text" id="book-title" placeholder="請輸入完整書名" required>
                </div>
                <div class="form-group">
                    <label for="book-author">
                        <i class="fas fa-user-pen"></i> 作者：
                    </label>
                    <input type="text" id="book-author" placeholder="可留空"> 
                </div>
                <div class="form-group">
                    <label for="book-cover-url">
                        <i class="fas fa-image"></i> 封面網址：
                    </label>
                    <input type="url" id="book-cover-url" placeholder="可留空">
                </div>
                <div class="form-group">
                    <label for="book-year">
                        <i class="fas fa-calendar"></i> 出版年份：
                    </label>
                    <input type="number" id="book-year" min="1900" max="2030" value="2024">
                </div>
                <div class="form-group">
                    <label for="book-copies">
                        <i class="fas fa-copy"></i> 冊數：
                    </label>
                    <input type="number" id="book-copies" min="1" value="1">
                    <small class="form-help">
                        <i class="fas fa-info-circle"></i> 
                        同一本書的複本數量
                    </small>
                </div>
                <div class="form-actions">
                    <button type="button" class="btn btn-outline" onclick="this.closest('.modal').style.display='none'">
                        <i class="fas fa-times"></i> 取消
                    </button>
                    <button type="button" id="auto-fill-add-book-btn" class="btn btn-info">
                        <i class="fas fa-magnifying-glass"></i> 自動搜尋
                    </button>
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-plus"></i> 新增書籍
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- 編輯書籍模態框 -->
    <div id="edit-book-modal" class="modal">
        <div class="modal-content">
            <span class="close">&times;</span>
            <h2><i class="fas fa-pen"></i> 編輯書籍</h2>
            <form id="edit-book-form">
                <input type="hidden" id="edit-book-original-id">
                <div class="form-group">
                    <label for="edit-book-id">
                        <i class="fas fa-barcode"></i> 書碼：
                    </label>
                    <input type="text" id="edit-book-id" required oninput="library.checkBookCodeDuplicate(this.value)">
                    <small class="form-help">
                        <i class="fas fa-info-circle"></i>
                        書碼格式：A/B/C + 數字（例：C0001）。修改書碼會更新所有相關借閱紀錄。
                    </small>
                    <div id="edit-book-id-error" class="field-error" style="display: none;"></div>
                </div>
                <div class="form-group">
                    <label for="edit-book-title">
                        <i class="fas fa-book"></i> 書名：
                    </label>
                    <div class="input-with-button">
                        <input type="text" id="edit-book-title" required>
                        <button type="button" class="btn btn-info btn-small" id="edit-book-search-btn" onclick="library.searchBookInfoFromEdit()">
                            <i class="fas fa-search"></i> 搜尋
                        </button>
                    </div>
                </div>
                <div class="form-group">
                    <label for="edit-book-author">
                        <i class="fas fa-user-pen"></i> 作者：
                    </label>
                    <input type="text" id="edit-book-author" placeholder="可留空">
                </div>
                <div class="form-group">
                    <label for="edit-book-cover-url">
                        <i class="fas fa-image"></i> 封面網址：
                    </label>
                    <input type="url" id="edit-book-cover-url" placeholder="可留空">
                </div>
                <div class="form-group">
                    <label for="edit-book-year">
                        <i class="fas fa-calendar"></i> 出版年份：
                    </label>
                    <input type="number" id="edit-book-year" min="1900" max="2030" value="2024">
                </div>
                <div class="form-group">
                    <label for="edit-book-copies">
                        <i class="fas fa-copy"></i> 冊數：
                    </label>
                    <input type="number" id="edit-book-copies" min="1" value="1">
                    <small class="form-help">
                        <i class="fas fa-info-circle"></i>
                        冊數不得小於目前已借出的數量。
                    </small>
                </div>
                <div class="form-actions">
                    <button type="button" class="btn btn-outline" onclick="this.closest('.modal').style.display='none'">
                        <i class="fas fa-times"></i> 取消
                    </button>
                    <button type="button" id="auto-fill-edit-book-btn" class="btn btn-info">
                        <i class="fas fa-magnifying-glass"></i> 自動搜尋
                    </button>
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-save"></i> 儲存變更
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- 設定模態框 -->
    <div id="settings-modal" class="modal">
        <div class="modal-content">
            <span class="close">&times;</span>
            <h2>系統設定</h2>
            
            <!-- 設定標籤頁 -->
            <div class="settings-tabs">
                <button class="tab-btn active" onclick="library.switchSettingsTab('basic')">
                    <i class="fas fa-cog"></i> 基本設定
                </button>
                <button class="tab-btn" onclick="library.switchSettingsTab('user-loan')">
                    <i class="fas fa-user-clock"></i> 使用者借閱時間
                </button>
            </div>

            <!-- 基本設定標籤頁 -->
            <div id="basic-settings" class="tab-content active">
                <form id="settings-form">
                    <div class="form-group">
                        <label for="loan-days">預設借閱天數：</label>
                        <input type="number" id="loan-days" min="1" value="14">
                        <small class="form-help">
                            <i class="fas fa-info-circle"></i>
                            新使用者的預設借閱天數
                        </small>
                    </div>
                    <div class="form-group">
                        <label for="guest-borrow">訪客可借閱：</label>
                        <input type="checkbox" id="guest-borrow">
                    </div>
                    <div class="form-group">
                        <label for="default-copies">預設冊數：</label>
                        <input type="number" id="default-copies" min="1" value="1">
                    </div>
                    <div class="form-group">
                        <label for="default-year">預設年份：</label>
                        <input type="number" id="default-year" min="1900" max="2030" value="2024">
                    </div>
                    <button type="submit" class="btn btn-primary">儲存設定</button>
                </form>
            </div>

            <!-- 使用者借閱時間標籤頁 -->
            <div id="user-loan-settings" class="tab-content">
                <div class="user-loan-management">
                    <div class="section-header">
                        <h3><i class="fas fa-user-clock"></i> 使用者借閱時間設定</h3>
                        <button class="btn btn-primary" onclick="library.showAddUserLoanModal()">
                            <i class="fas fa-plus"></i> 新增使用者設定
                        </button>
                    </div>
                    
                    <div class="search-section">
                        <input type="text" id="user-loan-search" placeholder="搜尋使用者名稱...">
                        <button class="btn btn-secondary" onclick="library.searchUserLoanSettings()">
                            <i class="fas fa-search"></i> 搜尋
                        </button>
                    </div>

                    <div id="user-loan-list">
                        <!-- 使用者借閱設定列表將在這裡動態生成 -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 使用者借閱設定模態框 -->
    <div id="user-loan-modal" class="modal">
        <div class="modal-content">
            <span class="close">&times;</span>
            <h2><i class="fas fa-user-clock"></i> 設定使用者借閱時間</h2>
            <form id="user-loan-form">
                <input type="hidden" id="user-loan-editing-index">
                
                <div class="form-group">
                    <label for="user-loan-username">
                        <i class="fas fa-user"></i> 使用者名稱：
                    </label>
                    <input type="text" id="user-loan-username" placeholder="輸入使用者名稱" required>
                    <small class="form-help">
                        <i class="fas fa-info-circle"></i>
                        請輸入要設定借閱時間的使用者名稱
                    </small>
                </div>
                
                <div class="form-group">
                    <label for="user-loan-days">
                        <i class="fas fa-calendar-days"></i> 借閱天數：
                    </label>
                    <input type="number" id="user-loan-days" min="1" max="365" required>
                    <small class="form-help">
                        <i class="fas fa-info-circle"></i>
                        此使用者每次借閱的可借天數（1-365天）
                    </small>
                </div>

                <div class="form-group">
                    <label for="user-loan-reason">
                        <i class="fas fa-comment"></i> 設定原因：
                    </label>
                    <textarea id="user-loan-reason" rows="3" placeholder="可選：說明設定此借閱時間的原因"></textarea>
                </div>

                <div class="form-actions">
                    <button type="button" class="btn btn-outline" onclick="this.closest('.modal').style.display='none'">
                        <i class="fas fa-times"></i> 取消
                    </button>
                    <button type="button" id="delete-user-loan-btn" class="btn btn-danger" style="display: none;">
                        <i class="fas fa-trash"></i> 刪除設定
                    </button>
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-save"></i> 儲存設定
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- 修改應還日期模態框 -->
    <div id="edit-due-date-modal" class="modal">
        <div class="modal-content">
            <span class="close">&times;</span>
            <h2><i class="fas fa-calendar-edit"></i> 修改應還日期</h2>
            <form id="edit-due-date-form">
                <input type="hidden" id="edit-due-date-borrow-id">
                
                <div class="form-group">
                    <label>
                        <i class="fas fa-book"></i> 書籍資訊：
                    </label>
                    <div id="edit-due-date-book-info" style="padding: 10px; background: #f8f9fa; border-radius: 6px; margin-bottom: 15px;">
                        <!-- 書籍資訊將在這裡動態生成 -->
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="edit-borrow-date">
                        <i class="fas fa-calendar-plus"></i> 新的借閱日期：
                    </label>
                    <input type="date" id="edit-borrow-date" required>
                    <small class="form-help">
                        <i class="fas fa-info-circle"></i>
                        請選擇新的借閱日期
                    </small>
                </div>

                <div class="form-group">
                    <label for="edit-due-date">
                        <i class="fas fa-calendar-check"></i> 新的應還日期：
                    </label>
                    <input type="date" id="edit-due-date" required>
                    <small class="form-help">
                        <i class="fas fa-info-circle"></i>
                        請選擇新的應還日期
                    </small>
                </div>

                <div class="form-group">
                    <label for="edit-due-date-reason">
                        <i class="fas fa-comment"></i> 修改原因：
                    </label>
                    <textarea id="edit-due-date-reason" rows="3" placeholder="請說明修改應還日期的原因"></textarea>
                </div>

                <div class="form-actions">
                    <button type="button" class="btn btn-outline" onclick="this.closest('.modal').style.display='none'">
                        <i class="fas fa-times"></i> 取消
                    </button>
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-save"></i> 儲存修改
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- 選擇借閱書碼模態框 -->
    <div id="choose-copy-modal" class="modal">
        <div class="modal-content">
            <span class="close">&times;</span>
            <h2><i class="fas fa-list-check"></i> 選擇要借的書碼</h2>
            <input type="hidden" id="choose-copy-selected">

            <div class="form-group">
                <label>
                    <i class="fas fa-book"></i> 書籍資訊：
                </label>
                <div id="choose-copy-book-info" style="padding: 10px; background: #f8f9fa; border-radius: 6px; margin-bottom: 15px;"></div>
            </div>

            <div class="form-group">
                <label>
                    <i class="fas fa-barcode"></i> 可借書碼：
                </label>
                <div id="choose-copy-list" style="display: flex; flex-wrap: wrap; gap: 10px;"></div>
            </div>

            <div class="form-actions">
                <button type="button" id="choose-copy-cancel" class="btn btn-outline">
                    <i class="fas fa-times"></i> 取消
                </button>
                <button type="button" id="choose-copy-confirm" class="btn btn-primary">
                    <i class="fas fa-check"></i> 確認借閱
                </button>
            </div>
        </div>
    </div>

    <!-- 借閱者清單模態框 -->
    <div id="borrowers-list-modal" class="modal">
        <div class="modal-content">
            <span class="close">&times;</span>
            <h2><i class="fas fa-users"></i> 借閱者清單</h2>
            
            <div class="borrowers-management">
                <div class="section-header">
                    <h3><i class="fas fa-user-friends"></i> 目前借閱者</h3>
                    <div class="borrowers-stats">
                        <span id="total-borrowers-count">0 位借閱者</span>
                    </div>
                </div>
                
                <div class="search-section">
                    <input type="text" id="borrowers-search" placeholder="搜尋借閱者姓名或電話...">
                    <button class="btn btn-secondary" onclick="library.searchBorrowers()">
                        <i class="fas fa-search"></i> 搜尋
                    </button>
                    <button class="btn btn-warning" onclick="library.showOverdueBorrowers()">
                        <i class="fas fa-exclamation-triangle"></i> 逾期借閱者
                    </button>
                </div>

                <div id="borrowers-list">
                    <!-- 借閱者列表將在這裡動態生成 -->
                </div>
            </div>
        </div>
    </div>

    <!-- 逾期通知模態框 -->
    <div id="overdue-notification-modal" class="modal">
        <div class="modal-content">
            <span class="close">&times;</span>
            <h2><i class="fas fa-bell"></i> 逾期通知</h2>
            <form id="overdue-notification-form">
                <input type="hidden" id="notification-borrower-id">
                
                <div class="form-group">
                    <label>
                        <i class="fas fa-user"></i> 借閱者資訊：
                    </label>
                    <div id="notification-borrower-info" style="padding: 10px; background: #fff3cd; border-radius: 6px; margin-bottom: 15px;">
                        <!-- 借閱者資訊將在這裡動態生成 -->
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="notification-method">
                        <i class="fas fa-paper-plane"></i> 通知方式：
                    </label>
                    <select id="notification-method" required>
                        <option value="phone">電話通知</option>
                        <option value="sms">簡訊通知</option>
                        <option value="email">電子郵件通知</option>
                        <option value="in-person">當面通知</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="notification-message">
                        <i class="fas fa-comment"></i> 通知內容：
                    </label>
                    <textarea id="notification-message" rows="4" required></textarea>
                </div>

                <div class="form-group">
                    <label for="notification-status">
                        <i class="fas fa-check-circle"></i> 通知狀態：
                    </label>
                    <select id="notification-status" required>
                        <option value="pending">待通知</option>
                        <option value="notified">已通知</option>
                        <option value="resolved">已處理</option>
                    </select>
                </div>

                <div class="form-actions">
                    <button type="button" class="btn btn-outline" onclick="this.closest('.modal').style.display='none'">
                        <i class="fas fa-times"></i> 取消
                    </button>
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-save"></i> 儲存通知記錄
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- 身分審核管理模態框 -->
    <div id="staff-approval-modal" class="modal">
        <div class="modal-content">
            <span class="close">&times;</span>
            <h2><i class="fas fa-user-check"></i> 身分審核管理</h2>
            
            <div class="approval-management">
                <div class="section-header">
                    <h3><i class="fas fa-clock"></i> 待審核申請</h3>
                    <div class="approval-stats">
                        <span id="pending-approval-count">0 筆待審核</span>
                    </div>
                </div>
                
                <div class="search-section">
                    <input type="text" id="approval-search" placeholder="搜尋申請人姓名或電話...">
                    <button class="btn btn-secondary" onclick="library.searchApplications()">
                        <i class="fas fa-search"></i> 搜尋
                    </button>
                    <button class="btn btn-success" onclick="library.syncApplicationsToGoogle()">
                        <i class="fas fa-cloud-upload-alt"></i> 同步到 Google Sheets
                    </button>
                </div>

                <div id="applications-list">
                    <!-- 申請列表將在這裡動態生成 -->
                </div>
            </div>
        </div>
    </div>

    <!-- 審核詳情模態框 -->
    <div id="approval-detail-modal" class="modal">
        <div class="modal-content">
            <span class="close">&times;</span>
            <h2><i class="fas fa-user-edit"></i> 審核申請</h2>
            <form id="approval-form">
                <input type="hidden" id="approval-application-id">
                
                <div class="form-group">
                    <label>
                        <i class="fas fa-user"></i> 申請人資訊：
                    </label>
                    <div id="approval-applicant-info" style="padding: 10px; background: #f8f9fa; border-radius: 6px; margin-bottom: 15px;">
                        <!-- 申請人資訊將在這裡動態生成 -->
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="approval-decision">
                        <i class="fas fa-gavel"></i> 審核決定：
                    </label>
                    <select id="approval-decision" required>
                        <option value="">請選擇審核結果</option>
                        <option value="approved">通過</option>
                        <option value="rejected">拒絕</option>
                        <option value="pending">保留待審</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="approval-reason">
                        <i class="fas fa-comment"></i> 審核意見：
                    </label>
                    <textarea id="approval-reason" rows="4" placeholder="請輸入審核意見或原因..."></textarea>
                </div>

                <div class="form-group">
                    <label for="approval-note">
                        <i class="fas fa-sticky-note"></i> 備註：
                    </label>
                    <textarea id="approval-note" rows="2" placeholder="其他備註資訊..."></textarea>
                </div>

                <div class="form-actions">
                    <button type="button" class="btn btn-outline" onclick="this.closest('.modal').style.display='none'">
                        <i class="fas fa-times"></i> 取消
                    </button>
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-save"></i> 儲存審核結果
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- 刪除身分模態框 -->
    <div id="delete-identity-modal" class="modal">
        <div class="modal-content">
            <span class="close">&times;</span>
            <h2><i class="fas fa-user-times"></i> 刪除身分</h2>
            
            <div class="delete-identity-management">
                <div class="section-header">
                    <h3><i class="fas fa-users"></i> 使用者列表</h3>
                    <div class="identity-stats">
                        <span id="total-users-count">0 位使用者</span>
                    </div>
                </div>
                
                <div class="search-section">
                    <input type="text" id="identity-search" placeholder="搜尋使用者姓名或帳號...">
                    <button class="btn btn-secondary" onclick="library.searchIdentities()">
                        <i class="fas fa-search"></i> 搜尋
                    </button>
                    <button class="btn btn-warning" onclick="library.refreshIdentityList()">
                        <i class="fas fa-sync"></i> 重新整理
                    </button>
                </div>

                <div id="identity-list">
                    <!-- 使用者列表將在這裡動態生成 -->
                </div>
            </div>
        </div>
    </div>

    <!-- 確認刪除模態框 -->
    <div id="confirm-delete-modal" class="modal">
        <div class="modal-content">
            <span class="close">&times;</span>
            <h2><i class="fas fa-exclamation-triangle"></i> 確認刪除</h2>
            
            <form id="confirm-delete-form">
                <input type="hidden" id="delete-username">
                
                <div class="form-group">
                    <label>
                        <i class="fas fa-user"></i> 使用者資訊：
                    </label>
                    <div id="delete-user-info" style="padding: 10px; background: #fee2e2; border-radius: 6px; margin-bottom: 15px;">
                        <!-- 使用者資訊將在這裡動態生成 -->
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="delete-reason">
                        <i class="fas fa-comment"></i> 刪除原因：
                    </label>
                    <textarea id="delete-reason" rows="3" placeholder="請輸入刪除原因..." required></textarea>
                </div>

                <div class="form-group">
                    <label>
                        <i class="fas fa-exclamation-triangle"></i> 刪除後果：
                    </label>
                    <div style="padding: 10px; background: #fef3c7; border-radius: 6px; margin-bottom: 15px;">
                        <ul style="margin: 0; padding-left: 20px;">
                            <li>使用者帳號將被永久刪除</li>
                            <li>相關的借閱記錄將被保留但無法歸還</li>
                            <li>身分申請記錄將被刪除</li>
                            <li>使用者將無法再登入系統</li>
                        </ul>
                    </div>
                </div>

                <div class="form-actions">
                    <button type="button" class="btn btn-outline" onclick="this.closest('.modal').style.display='none'">
                        <i class="fas fa-times"></i> 取消
                    </button>
                    <button type="submit" class="btn btn-danger">
                        <i class="fas fa-trash"></i> 確認刪除
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Google Sheets 同步模態框 -->
    <div id="google-sync-modal" class="modal">
        <div class="modal-content">
            <span class="close">&times;</span>
            <h2>Google Sheets 同步</h2>
            <form id="google-sync-form">
                <div class="form-group">
                    <label for="google-webapp-url">Apps Script Web App URL：</label>
                    <input type="url" id="google-webapp-url" placeholder="https://script.google.com/macros/s/.../exec" required>
                    <small class="form-help">
                        <i class="fas fa-info-circle"></i>
                        需先部署 Google Apps Script 成 Web App，並允許存取。此功能會同步：館藏、博幼藏書、借閱資料。
                    </small>
                </div>
                <div class="form-actions">
                    <button type="button" id="google-pull-btn" class="btn btn-info">
                        <i class="fas fa-cloud-download-alt"></i> 從線上下載
                    </button>
                    <button type="button" id="google-push-btn" class="btn btn-success">
                        <i class="fas fa-cloud-upload-alt"></i> 上傳到線上
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- 一鍵搜尋封面模態框 -->
    <div id="fetch-covers-modal" class="modal">
        <div class="modal-content">
            <span class="close">&times;</span>
            <h2><i class="fas fa-images"></i> 一鍵搜尋封面</h2>
            <form id="fetch-covers-form">
                <div class="form-group">
                    <label for="fetch-range">
                        <i class="fas fa-filter"></i> 搜尋範圍：
                    </label>
                    <select id="fetch-range" required>
                        <option value="all">全部書籍</option>
                        <option value="range">指定範圍</option>
                        <option value="genre">按類別</option>
                    </select>
                </div>
                
                <div id="range-options" style="display: none;">
                    <div class="form-group">
                        <label for="range-start">
                            <i class="fas fa-play"></i> 起始書碼：
                        </label>
                        <input type="text" id="range-start" placeholder="例：A0001">
                    </div>
                    <div class="form-group">
                        <label for="range-end">
                            <i class="fas fa-stop"></i> 結束書碼：
                        </label>
                        <input type="text" id="range-end" placeholder="例：A0100">
                    </div>
                </div>
                
                <div id="genre-options" style="display: none;">
                    <div class="form-group">
                        <label for="fetch-genre">
                            <i class="fas fa-tags"></i> 類別：
                        </label>
                        <select id="fetch-genre">
                            <option value="繪本">繪本 (A)</option>
                            <option value="橋梁書">橋梁書 (B)</option>
                            <option value="文字書">文字書 (C)</option>
                        </select>
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="fetch-type">
                        <i class="fas fa-search"></i> 搜尋類型：
                    </label>
                    <div style="display: flex; gap: 15px;">
                        <label style="display: flex; align-items: center; gap: 5px;">
                            <input type="checkbox" id="fetch-covers" checked>
                            <span>搜尋封面</span>
                        </label>
                        <label style="display: flex; align-items: center; gap: 5px;">
                            <input type="checkbox" id="fetch-authors" checked>
                            <span>搜尋作者</span>
                        </label>
                    </div>
                </div>
                
                <div class="form-actions">
                    <button type="button" class="btn btn-outline" onclick="this.closest('.modal').style.display='none'">
                        <i class="fas fa-times"></i> 取消
                    </button>
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-search"></i> 開始搜尋
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- 搜尋進度模態框 -->
    <div id="search-progress-modal" class="modal">
        <div class="modal-content">
            <h2><i class="fas fa-spinner fa-spin"></i> 搜尋進度</h2>
            <div class="progress-container">
                <div class="progress-info">
                    <div>目前處理：<span id="current-book-title">-</span></div>
                    <div>進度：<span id="progress-count">0</span> / <span id="progress-total">0</span></div>
                    <div>成功：<span id="success-count">0</span> | 失敗：<span id="fail-count">0</span></div>
                </div>
                <div class="progress-bar">
                    <div id="progress-fill" class="progress-fill"></div>
                </div>
                <div class="progress-controls">
                    <button id="pause-search-btn" class="btn btn-warning">
                        <i class="fas fa-pause"></i> 暫停
                    </button>
                    <button id="resume-search-btn" class="btn btn-success" style="display: none;">
                        <i class="fas fa-play"></i> 繼續
                    </button>
                    <button id="stop-search-btn" class="btn btn-danger">
                        <i class="fas fa-stop"></i> 停止
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Toast 通知 -->
    <div id="toast" class="toast"></div>

    <!-- 載入外部函式庫 -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="script.js"></script>
</body>
</html>
