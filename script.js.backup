// 圖書館管理系統核心功能
class LibrarySystem {
    constructor() {
        this.books = [];
        this.borrowedBooks = [];
        this.users = [];
        this.currentUser = null;
        this.adminUsername = 'sindy16872000';
        this.defaultGoogleWebAppUrl = 'https://script.google.com/macros/s/AKfycbxYZodHltoNvStyYHg3iHwflZ2W6g3vPNKftIOo3e8A22-jNL_-j_GmBbxzZwLt9Ot_/exec';
        this.autoSyncTimer = null;
        this.autoSyncLastRunAt = 0;
        this.autoSyncCooldownUntil = 0;
        this.autoSyncMinIntervalMs = 30000;
        this.autoSyncDebounceMs = 1500;
        this.pushNowInFlight = false;
        
        // API 節流與重試機制
        this.lastApiRequestTime = 0;
        this.apiRequestDelay = 2000; // 2 秒間隔，避免 429 錯誤
        this.apiRetryConfig = {
            maxRetries: 5, // 增加重試次數
            baseDelay: 2000, // 增加基礎延遲
            maxDelay: 16000 // 增加最大延遲
        };
        this.apiRequestQueue = [];
        this.apiRequestInProgress = false;
        
        // 搜尋狀態控制
        this.searchState = {
            isRunning: false,
            isPaused: false,
            shouldStop: false,
            currentIndex: 0,
            totalBooks: 0,
            successCount: 0,
            failCount: 0,
            searchQueue: []
        };
        
        this.settings = {
            loanDays: 14,
            guestBorrow: false,
            defaultCopies: 1,
            defaultYear: 2024,
            autoUpdateInterval: 300000,
            googleWebAppUrl: '',
            userLoanSettings: [] // 使用者借閱時間設定: [{username, days, reason, createdAt}]
        };
        this.updateTimer = null;
        this.lastUpdateTime = null;
        
        this.init();
    }

    // 初始化系統
    init() {
        this.loadData();
        this.setupEventListeners();
        this.syncBorrowedPanelForViewport();
        
        // 優先從 Google Sheets 載入最新資料
        this.autoLoadFromGoogleSheets();
        
        // 自動從 Google Sheets 載入線上資料（若已設定同步網址）
        this.startAutoPull();
        this.renderBooks();
        this.renderBorrowedBooks();
        this.updateStats();
        this.updateUserDisplay();
        this.updateAdminControls();
        this.startAutoUpdate();
    }

    isAdminUser() {
        return !!(this.currentUser && this.currentUser.username === this.adminUsername);
    }

    requireAdmin(actionName) {
        if (this.isAdminUser()) return true;
        this.showToast(`${actionName}：僅限管理者帳號 ${this.adminUsername}`, 'error');
        return false;
    }

    updateAdminControls() {
        const isAdmin = this.isAdminUser();
        const ids = [
            'google-sync-btn',
            'google-load-btn',
            'google-push-btn',
            'google-pull-btn',
            'settings-btn',
            'import-btn',
            'add-book-btn',
            'fetch-all-covers-btn',
            'reload-csv-btn',
            'export-csv-btn',
            'sync-google-to-csv-btn',
            'toggle-auto-update-btn',
            'reset-btn'
        ];

        ids.forEach(id => {
            const el = document.getElementById(id);
            if (!el) return;
            el.style.display = isAdmin ? '' : 'none';
            el.disabled = !isAdmin;
            el.title = '';
            el.style.opacity = '';
            el.style.cursor = '';
        });

        const fileInput = document.getElementById('file-input');
        if (fileInput) {
            fileInput.style.display = isAdmin ? '' : 'none';
            fileInput.disabled = !isAdmin;
        }
    }

    async pushToGoogleSheetsNow() {
        // 只有管理員才能執行上傳
        if (!this.isAdminUser()) return;
        
        const url = this.getGoogleWebAppUrl();
        if (!url) return;
        if (this.pushNowInFlight) return;

        this.pushNowInFlight = true;
        try {
            await this.pushToGoogleSheets({ silent: true });
        } catch (e) {
            console.error('pushToGoogleSheetsNow error:', e);
        } finally {
            this.pushNowInFlight = false;
        }
    }

    getGoogleWebAppUrl() {
        const url = (this.settings?.googleWebAppUrl || '').trim();
        return url || null;
    }

    startAutoPull() {
        const url = this.getGoogleWebAppUrl();
        if (!url) return;

        // 避免阻塞初始化，延後到下一輪事件迴圈
        setTimeout(() => {
            this.pullFromGoogleSheets({ silent: true, protectEmpty: true, closeModal: false });
        }, 0);
    }

    startAutoSync() {
        // 不用登入也能自動上傳，但必須先由管理者設定好 Web App URL
        // 這裡只做啟動，不做提示，避免干擾使用者
        this.scheduleAutoSync();
    }

    scheduleAutoSync() {
        if (this.autoSyncTimer) {
            clearTimeout(this.autoSyncTimer);
        }

        this.autoSyncTimer = setTimeout(() => {
            this.autoSyncTimer = null;
            this.autoPushToGoogleSheets();
        }, this.autoSyncDebounceMs);
    }

    async autoPushToGoogleSheets() {
        // 只有管理員才能執行自動上傳
        if (!this.isAdminUser()) return;
        
        const url = this.getGoogleWebAppUrl();
        if (!url) return;

        const now = Date.now();
        if (now < this.autoSyncCooldownUntil) return;
        if (now - this.autoSyncLastRunAt < this.autoSyncMinIntervalMs) return;
        this.autoSyncLastRunAt = now;

        try {
            await this.pushToGoogleSheets({ silent: true });
        } catch (e) {
            // 失敗後退避，避免一直打
            this.autoSyncCooldownUntil = Date.now() + 60000;
            console.error('autoPushToGoogleSheets error:', e);
        }
    }

    // 設定事件監聽器
    setupEventListeners() {
        // 搜尋和篩選
        document.getElementById('search-input').addEventListener('input', () => this.renderBooks());
        document.getElementById('genre-filter').addEventListener('change', () => this.renderBooks());
        document.getElementById('sort-by').addEventListener('change', () => this.renderBooks());
        document.getElementById('sort-order').addEventListener('change', () => this.renderBooks());
        document.getElementById('search-btn').addEventListener('click', () => this.renderBooks());

        // 管理功能
        document.getElementById('boyou-books-btn').addEventListener('click', () => this.goToBoyouBooks());
        document.getElementById('import-btn').addEventListener('click', () => {
            document.getElementById('file-input').click();
        });
        const settingsBtn = document.getElementById('settings-btn');
        if (settingsBtn) settingsBtn.addEventListener('click', () => this.showSettingsModal());
        document.getElementById('google-sync-btn').addEventListener('click', () => this.showGoogleSyncModal());
        document.getElementById('google-load-btn').addEventListener('click', () => this.loadFromGoogleSheets());
        document.getElementById('file-input').addEventListener('change', (e) => this.importBooks(e));
        document.getElementById('add-book-btn').addEventListener('click', () => this.showAddBookModal());
        document.getElementById('fetch-all-covers-btn').addEventListener('click', () => this.showFetchCoversModal());
        document.getElementById('reload-csv-btn').addEventListener('click', () => this.reloadCSV());
        document.getElementById('export-csv-btn').addEventListener('click', () => this.exportToCSV());
        document.getElementById('sync-google-to-csv-btn').addEventListener('click', () => this.syncGoogleSheetsToCSV());
        document.getElementById('toggle-auto-update-btn').addEventListener('click', () => this.toggleAutoUpdate());
        document.getElementById('reset-btn').addEventListener('click', () => this.resetData());
        document.getElementById('location-map-btn').addEventListener('click', () => this.showLocationMap());

        // 登入/登出
        document.getElementById('login-btn').addEventListener('click', () => this.showLoginModal());
        document.getElementById('logout-btn').addEventListener('click', () => this.logout());

        // 模態框
        this.setupModalListeners();

        // 表單提交
        document.getElementById('login-form').addEventListener('submit', (e) => this.handleLogin(e));
        document.getElementById('add-book-form').addEventListener('submit', (e) => this.handleAddBook(e));
        const settingsForm = document.getElementById('settings-form');
        if (settingsForm) settingsForm.addEventListener('submit', (e) => this.handleSaveSettings(e));
        const editBookForm = document.getElementById('edit-book-form');
        if (editBookForm) {
            editBookForm.addEventListener('submit', (e) => this.handleEditBook(e));
        }

        const fetchCoversForm = document.getElementById('fetch-covers-form');
        if (fetchCoversForm) {
            fetchCoversForm.addEventListener('submit', (e) => this.handleFetchCovers(e));
        }

        // 使用者借閱設定表單
        const userLoanForm = document.getElementById('user-loan-form');
        if (userLoanForm) {
            userLoanForm.addEventListener('submit', (e) => this.handleUserLoanForm(e));
        }

        // 刪除使用者借閱設定按鈕
        const deleteUserLoanBtn = document.getElementById('delete-user-loan-btn');
        if (deleteUserLoanBtn) {
            deleteUserLoanBtn.addEventListener('click', () => {
                const editingIndex = document.getElementById('user-loan-editing-index').value;
                if (editingIndex !== '') {
                    this.deleteUserLoanSetting(parseInt(editingIndex));
                }
            });
        }

        // 搜尋範圍選擇變更
        const fetchRange = document.getElementById('fetch-range');
        if (fetchRange) {
            fetchRange.addEventListener('change', (e) => this.toggleFetchOptions(e.target.value));
        }

        // 進度控制按鈕
        const pauseBtn = document.getElementById('pause-search-btn');
        const resumeBtn = document.getElementById('resume-search-btn');
        const stopBtn = document.getElementById('stop-search-btn');
        
        if (pauseBtn) pauseBtn.addEventListener('click', () => this.pauseSearch());
        if (resumeBtn) resumeBtn.addEventListener('click', () => this.resumeSearch());
        if (stopBtn) stopBtn.addEventListener('click', () => this.stopSearch());

        const autoFillAddBtn = document.getElementById('auto-fill-add-book-btn');
        if (autoFillAddBtn) {
            autoFillAddBtn.addEventListener('click', () => this.autoFillBookInfo({
                titleInputId: 'book-title',
                authorInputId: 'book-author',
                yearInputId: 'book-year',
                coverInputId: 'book-cover-url'
            }));
        }

        const autoFillEditBtn = document.getElementById('auto-fill-edit-book-btn');
        if (autoFillEditBtn) {
            autoFillEditBtn.addEventListener('click', () => this.autoFillBookInfo({
                titleInputId: 'edit-book-title',
                authorInputId: 'edit-book-author',
                yearInputId: 'edit-book-year',
                coverInputId: 'edit-book-cover-url'
            }));
        }

        // 視圖切換
        document.getElementById('grid-view').addEventListener('click', () => this.setView('grid'));
        document.getElementById('list-view').addEventListener('click', () => this.setView('list'));

        // 匯出借閱清單
        const exportBorrowedBtn = document.getElementById('export-borrowed-btn');
        if (exportBorrowedBtn) {
            exportBorrowedBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                this.exportBorrowedToExcel();
            });
        }

        const borrowedHeader = document.querySelector('.borrowed-header');
        if (borrowedHeader) {
            borrowedHeader.addEventListener('click', () => this.toggleBorrowedPanel());
            borrowedHeader.addEventListener('keydown', (e) => {
                if (e.key === 'Enter' || e.key === ' ') {
                    e.preventDefault();
                    this.toggleBorrowedPanel();
                }
            });
        }

        const borrowedToggleBtn = document.getElementById('borrowed-toggle-btn');
        if (borrowedToggleBtn) {
            borrowedToggleBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                this.toggleBorrowedPanel();
            });
        }

        const borrowedFab = document.getElementById('borrowed-fab');
        if (borrowedFab) {
            borrowedFab.addEventListener('click', () => this.toggleBorrowedPanel());
        }

        // Google Sheets 同步
        const googlePullBtn = document.getElementById('google-pull-btn');
        const googlePushBtn = document.getElementById('google-push-btn');
        if (googlePullBtn) googlePullBtn.addEventListener('click', () => this.pullFromGoogleSheets());
        if (googlePushBtn) googlePushBtn.addEventListener('click', () => this.pushToGoogleSheets());

        window.addEventListener('resize', () => this.syncBorrowedPanelForViewport());
    }

    syncBorrowedPanelForViewport() {
        const panel = document.querySelector('.borrowed-section');
        if (!panel) return;

        const isMobile = window.innerWidth <= 768;
        if (isMobile) {
            if (!panel.classList.contains('open') && !panel.classList.contains('minimized')) {
                panel.classList.add('minimized');
            }
        } else {
            if (!panel.classList.contains('open') && !panel.classList.contains('minimized')) {
                panel.classList.add('open');
            }
        }

        this.updateBorrowedToggleIcon();
    }

    toggleBorrowedPanel() {
        const panel = document.querySelector('.borrowed-section');
        if (!panel) return;

        const willOpen = !panel.classList.contains('open');
        if (willOpen) {
            panel.classList.add('open');
            panel.classList.remove('minimized');
        } else {
            panel.classList.remove('open');
            panel.classList.add('minimized');
        }

        this.updateBorrowedToggleIcon();
    }

    updateBorrowedToggleIcon() {
        const icon = document.querySelector('#borrowed-toggle-btn i');
        if (!icon) return;

        const panel = document.querySelector('.borrowed-section');
        if (!panel) return;

        const isOpen = panel.classList.contains('open');
        icon.className = isOpen ? 'fas fa-chevron-down' : 'fas fa-chevron-up';
    }

    // 設定模態框事件
    setupModalListeners() {
        const modals = document.querySelectorAll('.modal');
        const closes = document.querySelectorAll('.close');

        closes.forEach(close => {
            close.addEventListener('click', (e) => {
                const modal = e.target.closest('.modal');
                modal.style.display = 'none';
            });
        });

        window.addEventListener('click', (e) => {
            if (e.target.classList.contains('modal')) {
                e.target.style.display = 'none';
            }
        });
    }

    // 顯示位置圖
    showLocationMap() {
        const modal = document.getElementById('location-map-modal');
        if (modal) {
            modal.style.display = 'block';
        }
    }

    // 載入資料
    loadData() {
        this.books = JSON.parse(localStorage.getItem('lib_books_v1') || '[]');
        this.borrowedBooks = JSON.parse(localStorage.getItem('lib_borrowed_v1') || '[]');
        this.users = JSON.parse(localStorage.getItem('lib_users_v1') || '[]');
        this.currentUser = JSON.parse(localStorage.getItem('lib_active_user_v1') || 'null');

        const storedSettings = JSON.parse(localStorage.getItem('lib_settings_v1') || 'null');
        if (storedSettings && typeof storedSettings === 'object') {
            this.settings = { ...this.settings, ...storedSettings };
        }

        if (!this.settings.googleWebAppUrl) {
            this.settings.googleWebAppUrl = this.defaultGoogleWebAppUrl;
            localStorage.setItem('lib_settings_v1', JSON.stringify(this.settings));
        }
    }

    updateBorrowedToggleIcon() {
        const icon = document.querySelector('#borrowed-toggle-btn i');
        if (!icon) return;

        const panel = document.querySelector('.borrowed-section');
        if (!panel) return;

        const isOpen = panel.classList.contains('open');
        icon.className = isOpen ? 'fas fa-chevron-down' : 'fas fa-chevron-up';
    }

    // 設定模態框事件
    setupModalListeners() {
        const modals = document.querySelectorAll('.modal');
        const closes = document.querySelectorAll('.close');

        closes.forEach(close => {
            close.addEventListener('click', (e) => {
                const modal = e.target.closest('.modal');
                modal.style.display = 'none';
            });
        });

        window.addEventListener('click', (e) => {
            if (e.target.classList.contains('modal')) {
                e.target.style.display = 'none';
            }
        });
    }

    // 顯示位置圖
    showLocationMap() {
        const modal = document.getElementById('location-map-modal');
        if (modal) {
            modal.style.display = 'block';
        }
    }

    // 直接從 Google Sheets 載入書籍
    async loadFromGoogleSheets() {
        if (!this.requireAdmin('從 Google Sheets 載入')) return;

        const url = this.getGoogleWebAppUrl();
        if (!url) {
            this.showToast('請先在系統設定中設定 Google Sheets 同步網址', 'error');
            this.showGoogleSyncModal();
            return;
        }

        const confirmed = confirm('確定要從 Google Sheets 載入書籍資料嗎？\n這會覆蓋目前本機的所有書籍資料。');
        if (!confirmed) return;

        try {
            this.showToast('正在從 Google Sheets 載入書籍資料...', 'info');
            this.showLoadingIndicator(true);

            const response = await fetch(url, {
                method: 'POST',
                body: JSON.stringify({ action: 'pull' })
            });

            const result = await response.json().catch(() => null);
            if (!response.ok || !result || !result.ok) {
                throw new Error('Google Sheets 請求失敗');
            }

            const data = result.data || {};
            if (!Array.isArray(data.books)) {
                throw new Error('資料格式不正確');
            }

            if (data.books.length === 0) {
                const ok = confirm('Google Sheets 中沒有書籍資料。確定要清空本機館藏嗎？');
                if (!ok) {
                    this.showLoadingIndicator(false);
                    return;
                }
            }

            // 載入書籍資料
            this.books = data.books;
            this.borrowedBooks = Array.isArray(data.borrowedBooks) ? data.borrowedBooks : [];

            // 處理博幼藏書資料
            if (data.boyouBooks && typeof data.boyouBooks === 'object') {
                localStorage.setItem('lib_boyou_books_v1', JSON.stringify(data.boyouBooks));
            }

            // 儲存到本地
            this.saveData();
            
            // 重新渲染介面
            this.renderBooks();
            this.renderBorrowedBooks();
            this.updateStats();

            this.showLoadingIndicator(false);
            this.showToast(`成功載入 ${this.books.length} 本書籍資料`, 'success');

        } catch (error) {
            console.error('從 Google Sheets 載入失敗:', error);
            this.showLoadingIndicator(false);
            this.showToast('載入失敗，請檢查網路連線或 Google Sheets 設定', 'error');
        }
    }

    showGoogleSyncModal() {
        if (!this.requireAdmin('Google Sheets 同步')) return;
        const modal = document.getElementById('google-sync-modal');
        const urlInput = document.getElementById('google-webapp-url');
        if (urlInput) {
            urlInput.value = this.settings.googleWebAppUrl || '';
        }
        if (modal) {
            modal.style.display = 'block';
        }
    }

    showSettingsModal() {
        if (!this.requireAdmin('系統設定')) return;

        const modal = document.getElementById('settings-modal');
        const loanDays = document.getElementById('loan-days');
        const guestBorrow = document.getElementById('guest-borrow');
        const defaultCopies = document.getElementById('default-copies');
        const defaultYear = document.getElementById('default-year');

        if (loanDays) loanDays.value = String(this.settings.loanDays ?? 14);
        if (guestBorrow) guestBorrow.checked = !!this.settings.guestBorrow;
        if (defaultCopies) defaultCopies.value = String(this.settings.defaultCopies ?? 1);
        if (defaultYear) defaultYear.value = String(this.settings.defaultYear ?? 2024);

        // 初始化使用者借閱設定列表
        this.renderUserLoanSettings();

        if (modal) modal.style.display = 'block';
    }

    // 切換設定標籤頁
    switchSettingsTab(tabName) {
        // 隱藏所有標籤頁內容
        document.querySelectorAll('.tab-content').forEach(tab => {
            tab.classList.remove('active');
        });
        
        // 移除所有標籤按鈕的 active 狀態
        document.querySelectorAll('.tab-btn').forEach(btn => {
            btn.classList.remove('active');
        });
        
        // 顯示選中的標籤頁
        document.getElementById(tabName + '-settings').classList.add('active');
        
        // 啟用對應的標籤按鈕
        event.target.classList.add('active');
        
        // 如果切換到使用者借閱設定標籤，重新渲染列表
        if (tabName === 'user-loan') {
            this.renderUserLoanSettings();
        }
    }

    // 獲取使用者的借閱時間設定
    getUserLoanSetting(username) {
        if (!username || !this.settings.userLoanSettings) return null;
        return this.settings.userLoanSettings.find(setting => setting.username === username);
    }

    // 渲染使用者借閱設定列表
    renderUserLoanSettings() {
        const container = document.getElementById('user-loan-list');
        if (!container) return;

        const settings = this.settings.userLoanSettings || [];
        
        if (settings.length === 0) {
            container.innerHTML = `
                <div class="empty-user-loan-list">
                    <i class="fas fa-user-clock"></i>
                    <h3>尚未設定任何使用者借閱時間</h3>
                    <p>點擊「新增使用者設定」為特定使用者設定借閱時間</p>
                </div>
            `;
            return;
        }

        container.innerHTML = settings.map((setting, index) => `
            <div class="user-loan-item">
                <div class="user-loan-info">
                    <div class="user-loan-username">${setting.username}</div>
                    <div class="user-loan-details">
                        可借閱 ${setting.days} 天
                        ${setting.reason ? ` - ${setting.reason}` : ''}
                        <br>
                        <small>設定於 ${new Date(setting.createdAt).toLocaleDateString()}</small>
                    </div>
                </div>
                <div class="user-loan-days">${setting.days} 天</div>
                <div class="user-loan-actions">
                    <button class="btn btn-info btn-small" onclick="library.editUserLoanSetting(${index})">
                        <i class="fas fa-edit"></i> 編輯
                    </button>
                    <button class="btn btn-danger btn-small" onclick="library.deleteUserLoanSetting(${index})">
                        <i class="fas fa-trash"></i> 刪除
                    </button>
                </div>
            </div>
        `).join('');
    }

    // 顯示新增/編輯使用者借閱設定模態框
    showAddUserLoanModal(editIndex = null) {
        const modal = document.getElementById('user-loan-modal');
        const form = document.getElementById('user-loan-form');
        const deleteBtn = document.getElementById('delete-user-loan-btn');
        
        // 重置表單
        form.reset();
        document.getElementById('user-loan-editing-index').value = editIndex || '';
        
        if (editIndex !== null) {
            // 編輯模式
            const setting = this.settings.userLoanSettings[editIndex];
            document.getElementById('user-loan-username').value = setting.username;
            document.getElementById('user-loan-days').value = setting.days;
            document.getElementById('user-loan-reason').value = setting.reason || '';
            deleteBtn.style.display = 'inline-block';
        } else {
            // 新增模式
            deleteBtn.style.display = 'none';
        }
        
        if (modal) modal.style.display = 'block';
    }

    // 編輯使用者借閱設定
    editUserLoanSetting(index) {
        this.showAddUserLoanModal(index);
    }

    // 刪除使用者借閱設定
    deleteUserLoanSetting(index) {
        if (!confirm('確定要刪除這個使用者的借閱時間設定嗎？')) return;
        
        this.settings.userLoanSettings.splice(index, 1);
        this.saveData();
        this.renderUserLoanSettings();
        this.showToast('使用者借閱設定已刪除', 'success');
    }

    // 從借閱記錄編輯使用者借閱時間設定
    editUserLoanFromBorrowed(username) {
        if (!this.isAdminUser()) {
            this.showToast('只有管理員可以修改借閱時間設定', 'error');
            return;
        }

        // 查找現有的使用者借閱設定
        const existingIndex = this.settings.userLoanSettings.findIndex(setting => setting.username === username);
        
        if (existingIndex !== -1) {
            // 如果已有設定，直接編輯
            this.editUserLoanSetting(existingIndex);
        } else {
            // 如果沒有設定，新增一個新的設定
            this.showAddUserLoanModal(null);
            // 預填使用者名稱
            document.getElementById('user-loan-username').value = username;
            document.getElementById('user-loan-username').readOnly = true; // 鎖定使用者名稱欄位
        }
    }
            this.showToast('請輸入使用者名稱', 'error');
            return;
        }
        
        if (!Number.isFinite(days) || days < 1 || days > 365) {
            this.showToast('借閱天數必須在 1-365 天之間', 'error');
            return;
        }
        
        const setting = {
            username,
            days,
            reason,
            createdAt: editingIndex ? this.settings.userLoanSettings[editingIndex].createdAt : new Date().toISOString()
        };
        
        if (editingIndex !== '') {
            // 更新現有設定
            this.settings.userLoanSettings[parseInt(editingIndex)] = setting;
            this.showToast('使用者借閱設定已更新', 'success');
        } else {
            // 檢查是否已存在該使用者的設定
            if (this.getUserLoanSetting(username)) {
                this.showToast('該使用者已有借閱時間設定，請使用編輯功能修改', 'warning');
                return;
            }
            // 新增設定
            this.settings.userLoanSettings.push(setting);
            this.showToast('使用者借閱設定已新增', 'success');
        }
        
        this.saveData();
        this.renderUserLoanSettings();
        
        // 關閉模態框
        document.getElementById('user-loan-modal').style.display = 'none';
    }

    // 搜尋使用者借閱設定
    searchUserLoanSettings() {
        const searchTerm = document.getElementById('user-loan-search').value.trim().toLowerCase();
        const container = document.getElementById('user-loan-list');
        
        if (!searchTerm) {
            this.renderUserLoanSettings();
            return;
        }
        
        const settings = this.settings.userLoanSettings || [];
        const filteredSettings = settings.filter(setting => 
            setting.username.toLowerCase().includes(searchTerm)
        );
        
        if (filteredSettings.length === 0) {
            container.innerHTML = `
                <div class="empty-user-loan-list">
                    <i class="fas fa-search"></i>
                    <h3>找不到符合的使用者設定</h3>
                    <p>請嘗試其他搜尋關鍵字</p>
                </div>
            `;
            return;
        }
        
        // 使用過濾後的設定重新渲染列表
        const originalSettings = this.settings.userLoanSettings;
        this.settings.userLoanSettings = filteredSettings;
        this.renderUserLoanSettings();
        this.settings.userLoanSettings = originalSettings;
    }

    handleSaveSettings(e) {
        e.preventDefault();
        if (!this.requireAdmin('儲存設定')) return;

        let loanDays = parseInt(document.getElementById('loan-days')?.value, 10);
        if (!Number.isFinite(loanDays) || loanDays < 1) loanDays = 14;
        const guestBorrow = !!document.getElementById('guest-borrow')?.checked;
        const defaultCopies = parseInt(document.getElementById('default-copies')?.value) || 1;
        const defaultYear = parseInt(document.getElementById('default-year')?.value) || 2024;

        this.settings.loanDays = loanDays;
        this.settings.guestBorrow = guestBorrow;
        this.settings.defaultCopies = defaultCopies;
        this.settings.defaultYear = defaultYear;

        this.saveData();
        this.renderBooks();

        const modal = document.getElementById('settings-modal');
        if (modal) modal.style.display = 'none';
        this.showToast('設定已儲存', 'success');
    }

    getGoogleWebAppUrlFromUI() {
        const urlInput = document.getElementById('google-webapp-url');
        const url = urlInput ? urlInput.value.trim() : '';
        if (!url) {
            this.showToast('請先填入 Apps Script Web App URL', 'error');
            return null;
        }
        this.settings.googleWebAppUrl = url;
        this.saveData();
        return url;
    }

    async pushToGoogleSheets(options = {}) {
        const { silent = false } = options;
        
        // 檢查管理員權限（非靜默操作需要權限）
        if (!silent && !this.requireAdmin('上傳到 Google Sheets')) return;
        
        const url = this.getGoogleWebAppUrl();
        if (!url) {
            if (!silent) this.showToast('請先由管理者設定 Google Sheets 同步網址', 'error');
            return;
        }

        try {
            if (!silent) this.showToast('正在上傳到 Google Sheets...', 'info');
            const boyouBooks = JSON.parse(localStorage.getItem('lib_boyou_books_v1') || 'null') || {};
            const response = await fetch(url, {
                method: 'POST',
                body: JSON.stringify({
                    action: 'push',
                    payload: {
                        books: this.books,
                        borrowedBooks: this.borrowedBooks,
                        boyouBooks
                    }
                })
            });

            const result = await response.json().catch(() => null);
            if (!response.ok) {
                if (!silent) this.showToast('上傳失敗，請檢查 Web App 權限/網址', 'error');
                return;
            }

            if (result && result.ok) {
                if (!silent) this.showToast('上傳完成', 'success');
            } else {
                if (!silent) this.showToast('上傳完成，但回應格式不符', 'warning');
            }
        } catch (error) {
            console.error('pushToGoogleSheets error:', error);
            if (!silent) this.showToast('上傳失敗，請檢查網路或 CORS 設定', 'error');
            throw error;
        }
    }

    async pullFromGoogleSheets(options = {}) {
        const { silent = false, protectEmpty = false, closeModal = true } = options;
        const url = silent ? this.getGoogleWebAppUrl() : this.getGoogleWebAppUrlFromUI();
        if (!url) return;

        try {
            if (!silent) this.showToast('正在從 Google Sheets 下載...', 'info');
            const response = await fetch(url, {
                method: 'POST',
                body: JSON.stringify({ action: 'pull' })
            });

            const result = await response.json().catch(() => null);
            if (!response.ok || !result || !result.ok) {
                if (!silent) this.showToast('下載失敗，請檢查 Web App 權限/網址', 'error');
                return;
            }

            const data = result.data || {};
            if (!Array.isArray(data.books) || !Array.isArray(data.borrowedBooks)) {
                if (!silent) this.showToast('下載失敗：資料格式不正確', 'error');
                return;
            }

            if (protectEmpty && data.books.length === 0 && Array.isArray(this.books) && this.books.length > 0) {
                // 自動載入模式：線上空資料時不覆蓋本機，避免把館藏清空
                return;
            }

            if (data.books.length === 0 && Array.isArray(this.books) && this.books.length > 0) {
                const ok = confirm('線上 Books 資料是空的，下載會清空目前館藏。確定要覆蓋嗎？');
                if (!ok) {
                    if (!silent) this.showToast('已取消下載覆蓋', 'info');
                    return;
                }
            }

            this.books = data.books;
            this.borrowedBooks = data.borrowedBooks;

            if (data.boyouBooks && typeof data.boyouBooks === 'object') {
                localStorage.setItem('lib_boyou_books_v1', JSON.stringify(data.boyouBooks));
            }
            this.saveData();
            this.renderBooks();
            this.renderBorrowedBooks();
            this.updateStats();
            if (!silent) this.showToast('下載完成並已同步到本機', 'success');

            if (closeModal) {
                const modal = document.getElementById('google-sync-modal');
                if (modal) modal.style.display = 'none';
            }
        } catch (error) {
            console.error('pullFromGoogleSheets error:', error);
            if (!silent) this.showToast('下載失敗，請檢查網路或 CORS 設定', 'error');
        }
    }

    async autoLoadFromGoogleSheets() {
        const url = this.getGoogleWebAppUrl();
        if (!url) {
            console.log('未設定 Google Sheets URL，跳過自動載入');
            // 嘗試載入本地 CSV 檔案作為備案
            await this.autoLoadCSV();
            return;
        }

        try {
            console.log('開始從 Google Sheets 自動載入書籍資料...');
            
            const response = await fetch(url, {
                method: 'POST',
                body: JSON.stringify({ action: 'pull' })
            });

            const result = await response.json().catch(() => null);
            if (!response.ok || !result || !result.ok) {
                console.log('Google Sheets 載入失敗:', result?.error || '未知錯誤');
                this.showToast('Google Sheets 載入失敗，嘗試載入本地 CSV 檔案...', 'warning');
                // 當 Google Sheets 失敗時，自動載入本地 CSV 檔案
                await this.autoLoadCSV();
                return;
            }

            const data = result.data || {};
            if (!Array.isArray(data.books)) {
                console.log('Google Sheets 資料格式不正確');
                this.showToast('Google Sheets 資料格式錯誤，嘗試載入本地 CSV 檔案...', 'warning');
                // 當資料格式錯誤時，自動載入本地 CSV 檔案
                await this.autoLoadCSV();
                return;
            }

            // 處理書籍資料
            this.books = data.books || [];
            this.borrowedBooks = data.borrowedBooks || [];
            
            // 處理博幼藏書
            const boyouBooks = data.boyouBooks || {};
            localStorage.setItem('lib_boyou_books_v1', JSON.stringify(boyouBooks));

            this.saveData();
            this.lastUpdateTime = new Date();
            this.updateLastUpdateDisplay();
            
            if (this.books.length > 0) {
                console.log(`成功從 Google Sheets 載入 ${this.books.length} 本書籍`);
                this.showToast(`已從 Google Sheets 載入 ${this.books.length} 本書籍`, 'success');
            } else {
                console.log('Google Sheets 中沒有書籍資料，嘗試載入本地 CSV 檔案...');
                this.showToast('Google Sheets 中沒有書籍資料，嘗試載入本地 CSV 檔案...', 'warning');
                // 當線上沒有資料時，也嘗試載入本地 CSV 檔案
                await this.autoLoadCSV();
            }

        } catch (error) {
            console.error('自動從 Google Sheets 載入失敗:', error);
            this.showToast('Google Sheets 載入失敗，嘗試載入本地 CSV 檔案...', 'warning');
            // 當發生錯誤時，自動載入本地 CSV 檔案
            await this.autoLoadCSV();
        }
    }

    // 自動載入 CSV 檔案
    async autoLoadCSV() {
        console.log('開始載入本地 CSV 檔案');
        try {
            // 顯示載入中狀態
            this.showLoadingIndicator(true);
            
            // 載入本地 CSV 檔案
            const response = await fetch('113博幼館藏.csv');
            if (!response.ok) {
                console.log('本地 CSV 檔案載入失敗');
                this.showLoadingIndicator(false);
                return;
            }

            const csvText = await response.text();
            const csvData = this.parseCSV(csvText);
            
            if (csvData.length > 0) {
                this.processCSVData(csvData);
                this.lastUpdateTime = new Date();
                this.updateLastUpdateDisplay();
                this.showToast(`已載入本地 CSV 資料 (${csvData.length} 筆)`, 'success');
            }
            
            this.showLoadingIndicator(false);
        } catch (error) {
            console.log('載入失敗:', error);
            this.showLoadingIndicator(false);
        }
    }




    // 解析 CSV 文字
    parseCSV(csvText) {
        console.log('開始解析 CSV 文字，長度:', csvText.length);
        const lines = csvText.split('\n');
        console.log('CSV 行數:', lines.length);
        const data = [];
        
        for (let i = 0; i < lines.length; i++) {
            const line = lines[i].trim();
            if (!line) continue;
            
            // 跳過標題行和空行
            if (i < 4) {
                console.log(`跳過第${i}行 (標題行):`, line);
                continue;
            }
            
            const columns = line.split(',');
            if (columns.length >= 2 && columns[0]) {
                console.log(`處理第${i}行:`, columns[0], columns[1]);
                data.push(columns);
            } else {
                console.log(`跳過第${i}行 (格式不符):`, line);
            }
        }
        
        console.log('CSV 解析完成，共', data.length, '筆有效資料');
        return data;
    }

    // 處理 CSV 資料
    processCSVData(csvData) {
        console.log('開始處理 CSV 資料，共', csvData.length, '筆');
        console.log('處理前書籍數量:', this.books.length);
        
        // 清空現有書籍資料，避免累積
        this.books = [];
        
        let successCount = 0;
        let errorCount = 0;
        const errors = [];
        const bookMap = new Map(); // 用於合併相同書名的書籍

        for (let i = 0; i < csvData.length; i++) {
            const row = csvData[i];
            if (!row || row.length === 0 || !row[0]) continue;

            const id = row[0].toString().trim();
            let title = row[1] ? row[1].toString().trim() : '';

            // 驗證書碼格式
            if (!/^[ABC]\d+$/.test(id)) {
                errors.push(`第${i+5}行：書碼格式錯誤 (${id})`);
                errorCount++;
                continue;
            }

            // 如果書名為空，跳過此記錄
            if (!title) {
                console.log(`跳過第${i+5}行：書名為空 (${id})`);
                continue;
            }

            // 檢查重複書碼（在當前處理的資料中）
            if (bookMap.has(title) && bookMap.get(title).bookIds.includes(id)) {
                errors.push(`第${i+5}行：書碼重複 (${id})`);
                errorCount++;
                continue;
            }

            const genre = this.getGenreFromId(id);
            const year = this.settings.defaultYear;
            const copies = 1; // 預設冊數為 1

            // 檢查是否已存在相同書名的書籍
            if (bookMap.has(title)) {
                const existingBook = bookMap.get(title);
                existingBook.copies += copies;
                existingBook.availableCopies += copies;
                existingBook.bookIds.push(id); // 記錄所有書碼
            } else {
                const newBook = {
                    id, // 主要書碼
                    bookIds: [id], // 所有書碼列表
                    title,
                    genre,
                    year,
                    copies,
                    availableCopies: copies
                };
                bookMap.set(title, newBook);
            }
            successCount++;
        }

        // 將合併後的書籍添加到陣列中
        for (const book of bookMap.values()) {
            this.books.push(book);
        }

        console.log('處理完成，共載入', this.books.length, '本書籍');
        console.log('書籍列表:', this.books);

        this.saveData();

        if (successCount > 0) {
            console.log(`成功載入 ${successCount} 本書籍`);
        }
        if (errorCount > 0) {
            console.log(`有 ${errorCount} 筆資料載入失敗`);
            console.log('載入錯誤:', errors);
        }
    }

    // 儲存資料
    saveData() {
        localStorage.setItem('lib_books_v1', JSON.stringify(this.books));
        localStorage.setItem('lib_borrowed_v1', JSON.stringify(this.borrowedBooks));
        localStorage.setItem('lib_users_v1', JSON.stringify(this.users));
        localStorage.setItem('lib_active_user_v1', JSON.stringify(this.currentUser));
        localStorage.setItem('lib_settings_v1', JSON.stringify(this.settings));
        
        // 自動上傳到 Google Sheets
        this.autoSyncToGoogleSheets();
    }

    // 自動同步到 Google Sheets
    async autoSyncToGoogleSheets() {
        const url = this.getGoogleWebAppUrl();
        if (!url) {
            // 如果沒有設定 Google Sheets，靜默跳過
            return;
        }

        try {
            // 防止頻繁上傳，設定一個短暫的延遲
            if (this.autoSyncTimeout) {
                clearTimeout(this.autoSyncTimeout);
            }

            this.autoSyncTimeout = setTimeout(async () => {
                const boyouBooks = JSON.parse(localStorage.getItem('lib_boyou_books_v1') || 'null') || {};
                const response = await fetch(url, {
                    method: 'POST',
                    body: JSON.stringify({
                        action: 'push',
                        payload: {
                            books: this.books,
                            borrowedBooks: this.borrowedBooks,
                            boyouBooks
                        }
                    })
                });

                const result = await response.json().catch(() => null);
                if (response.ok && result && result.ok) {
                    console.log('自動同步到 Google Sheets 成功');
                    // 可以選擇性地顯示一個小圖標或訊息
                    this.showSyncIndicator('已同步', 'success');
                } else {
                    console.log('自動同步到 Google Sheets 失敗');
                }
            }, 1000); // 延遲1秒上傳，避免頻繁請求

        } catch (error) {
            console.error('自動同步到 Google Sheets 失敗:', error);
            // 靜默失敗，不影響本地操作
        }
    }

    // 顯示同步指示器
    showSyncIndicator(message, type = 'info') {
        // 創建或更新同步指示器
        let indicator = document.getElementById('sync-indicator');
        if (!indicator) {
            indicator = document.createElement('div');
            indicator.id = 'sync-indicator';
            indicator.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                padding: 8px 16px;
                border-radius: 20px;
                font-size: 0.8rem;
                font-weight: 600;
                z-index: 10000;
                transition: all 0.3s ease;
                pointer-events: none;
            `;
            document.body.appendChild(indicator);
        }

        // 設置樣式和訊息
        if (type === 'success') {
            indicator.style.backgroundColor = '#48bb78';
            indicator.style.color = 'white';
        } else {
            indicator.style.backgroundColor = '#667eea';
            indicator.style.color = 'white';
        }
        
        indicator.textContent = message;
        indicator.style.opacity = '1';

        // 3秒後淡出
        setTimeout(() => {
            indicator.style.opacity = '0';
            setTimeout(() => {
                if (indicator.parentNode) {
                    indicator.parentNode.removeChild(indicator);
                }
            }, 300);
        }, 3000);
    }

    // 顯示登入模態框
    showLoginModal() {
        document.getElementById('login-modal').style.display = 'block';
    }

    // 處理登入
    handleLogin(e) {
        e.preventDefault();
        const username = document.getElementById('username').value;
        const role = document.getElementById('user-role').value;

        if (!username.trim()) {
            this.showToast('請輸入使用者名稱', 'error');
            return;
        }

        this.currentUser = { username, role };
        this.saveData();
        this.updateUserDisplay();
        this.updateAdminControls();
        if (!this.isAdminUser()) {
            this.stopAutoUpdate();
        } else {
            this.startAutoUpdate();
        }
        this.renderBooks();
        this.renderBorrowedBooks();
        
        document.getElementById('login-modal').style.display = 'none';
        document.getElementById('login-form').reset();
        this.showToast(`歡迎 ${username}！`, 'success');
    }

    // 登出
    logout() {
        this.currentUser = null;
        this.saveData();
        this.updateUserDisplay();
        this.updateAdminControls();
        this.stopAutoUpdate();
        this.renderBooks();
        this.renderBorrowedBooks();
        this.showToast('已登出', 'success');
    }

    // 更新使用者顯示
    updateUserDisplay() {
        const currentUserSpan = document.getElementById('current-user');
        const loginBtn = document.getElementById('login-btn');
        const logoutBtn = document.getElementById('logout-btn');

        if (this.currentUser) {
            currentUserSpan.textContent = `${this.currentUser.username} (${this.getRoleName(this.currentUser.role)})`;
            loginBtn.style.display = 'none';
            logoutBtn.style.display = 'inline-flex';
        } else {
            currentUserSpan.textContent = '訪客';
            loginBtn.style.display = 'inline-flex';
            logoutBtn.style.display = 'none';
        }
    }

    // 取得角色名稱
    getRoleName(role) {
        const roleNames = {
            'guest': '訪客',
            'student': '學生',
            'staff': '老師/館員'
        };
        return roleNames[role] || '未知';
    }

    // 顯示新增書籍模態框
    showAddBookModal() {
        if (!this.requireAdmin('新增館藏')) return;
        document.getElementById('add-book-modal').style.display = 'block';
        
        // 設定預設值
        document.getElementById('book-year').value = this.settings.defaultYear;
        document.getElementById('book-copies').value = this.settings.defaultCopies;
        
        // 清空表單
        document.getElementById('add-book-form').reset();
        
        // 重新設定預設值（因為reset會清空）
        document.getElementById('book-year').value = this.settings.defaultYear;
        document.getElementById('book-copies').value = this.settings.defaultCopies;
        const authorInput = document.getElementById('book-author');
        if (authorInput) authorInput.value = '';

        // 預填下一個書碼（仍可手動修改）
        const suggestedId = this.suggestNextBookId();
        const bookIdInput = document.getElementById('book-id');
        const bookPrefixSelect = document.getElementById('book-prefix');

        if (bookPrefixSelect) {
            const m = String(suggestedId || '').toUpperCase().match(/^([ABC])/);
            bookPrefixSelect.value = m ? m[1] : 'C';
        }
        if (bookIdInput && suggestedId) {
            bookIdInput.value = suggestedId;
        }

        if (suggestedId) {
            this.showToast(`已預填書碼 ${suggestedId}，可從此號開始編輯（可自行修改）`, 'info');
        }
        
        // 聚焦到書碼輸入框
        setTimeout(() => {
            document.getElementById('book-id').focus();
            if (document.getElementById('book-id')?.value) {
                document.getElementById('book-id').select();
            }
        }, 100);
        
        // 添加實時驗證
        this.setupAddBookValidation();
    }

    suggestNextBookId() {
        const genreFilter = document.getElementById('genre-filter')?.value;
        const prefixMap = { '繪本': 'A', '橋梁書': 'B', '文字書': 'C' };
        const prefix = prefixMap[genreFilter] || 'C';
        return this.generateNextBookId(prefix);
    }

    generateNextBookId(prefix) {
        const used = new Set();

        this.books.forEach(book => {
            if (book?.id) used.add(String(book.id).toUpperCase());
            if (Array.isArray(book?.bookIds)) {
                book.bookIds.forEach(id => {
                    if (id) used.add(String(id).toUpperCase());
                });
            }
        });

        let next = 1;
        while (true) {
            const candidate = `${prefix}${String(next).padStart(4, '0')}`;
            if (!used.has(candidate)) return candidate;
            next++;
        }
    }

    hasBookId(id) {
        const target = String(id || '').trim().toUpperCase();
        if (!target) return false;

        return this.books.some(book => {
            if (!book) return false;
            if (String(book.id || '').toUpperCase() === target) return true;
            if (Array.isArray(book.bookIds) && book.bookIds.some(x => String(x || '').toUpperCase() === target)) return true;
            return false;
        });
    }

    // 處理新增書籍
    handleAddBook(e) {
        e.preventDefault();

        try {
            const idEl = document.getElementById('book-id');
            const titleEl = document.getElementById('book-title');
            const authorEl = document.getElementById('book-author');
            const coverEl = document.getElementById('book-cover-url');
            const yearEl = document.getElementById('book-year');
            const copiesEl = document.getElementById('book-copies');

            if (!idEl || !titleEl || !yearEl || !copiesEl) {
                this.showToast('新增失敗：表單欄位不存在，請重新整理頁面', 'error');
                return;
            }

            const id = idEl.value.trim().toUpperCase();
            const title = titleEl.value.trim();
            const author = (authorEl?.value || '').trim();
            const coverUrl = (coverEl?.value || '').trim();
            const year = parseInt(yearEl.value) || this.settings.defaultYear;
            const copies = parseInt(copiesEl.value) || this.settings.defaultCopies;

            // 驗證書碼格式（支援全形和半形字符）
            if (!/^[ABC]\d+$/.test(id)) {
                this.showToast('書碼格式錯誤：請用 A/B/C + 數字（例：C0001）', 'error');
                return;
            }

            // 檢查重複書碼
            if (this.hasBookId(id)) {
                this.showToast('書碼已存在', 'error');
                return;
            }

            if (!title) {
                this.showToast('請輸入書名', 'error');
                return;
            }

            const genre = this.getGenreFromId(id);
            const newBook = {
                id,
                title,
                author,
                coverUrl,
                genre,
                year,
                copies,
                availableCopies: copies,
                isNew: true,
                addedAt: Date.now()
            };

            this.books.push(newBook);
            this.saveData();
            // 新增館藏後也自動同步到 Google Sheets
            this.scheduleAutoSync();
            this.pushToGoogleSheetsNow();
            this.renderBooks();
            this.updateStats();

            const modal = document.getElementById('add-book-modal');
            if (modal) modal.style.display = 'none';
            const form = document.getElementById('add-book-form');
            if (form) form.reset();

            this.showToast('書籍新增成功！', 'success');
        } catch (err) {
            console.error('handleAddBook error:', err);
            this.showToast(`新增失敗：${err?.message || err}`, 'error');
        }
    }

    // 設定新增書籍表單的實時驗證
    setupAddBookValidation() {
        const bookIdInput = document.getElementById('book-id');
        const bookTitleInput = document.getElementById('book-title');
        const bookPrefixSelect = document.getElementById('book-prefix');

        if (!bookIdInput || !bookTitleInput) return;

        if (bookPrefixSelect && !bookPrefixSelect.dataset.bound) {
            bookPrefixSelect.dataset.bound = '1';
            bookPrefixSelect.addEventListener('change', (e) => {
                const prefix = String(e.target.value || '').toUpperCase();
                if (!/^[ABC]$/.test(prefix)) return;
                const generated = this.generateNextBookId(prefix);
                if (bookIdInput) bookIdInput.value = generated;
                if (bookIdInput) bookIdInput.dispatchEvent(new Event('input'));
            });
        }
        
        // 書碼格式驗證
        if (!bookIdInput.dataset.bound) {
            bookIdInput.dataset.bound = '1';
            bookIdInput.addEventListener('input', (e) => {
            const value = e.target.value.trim();
            const upper = value.toUpperCase();

            if (/^[ABC]$/.test(upper)) {
                const generated = this.generateNextBookId(upper);
                e.target.value = generated;
            }

            if (bookPrefixSelect) {
                const m = String(e.target.value || '').toUpperCase().match(/^([ABC])/);
                if (m) bookPrefixSelect.value = m[1];
            }

            const currentValue = e.target.value.trim().toUpperCase();
            const isValid = /^[ABC]\d+$/.test(currentValue);
            
            if (currentValue && !isValid) {
                e.target.style.borderColor = '#f56565';
                this.showFieldError('book-id', '書碼格式：A/B/C + 數字');
            } else {
                e.target.style.borderColor = '#e2e8f0';
                this.hideFieldError('book-id');
            }

            if (/^[ABC]\d+$/.test(currentValue) && this.hasBookId(currentValue)) {
                e.target.style.borderColor = '#f56565';
                this.showFieldError('book-id', '書碼已存在');
            }
            });
        }
        
        // 書名驗證
        if (!bookTitleInput.dataset.bound) {
            bookTitleInput.dataset.bound = '1';
            bookTitleInput.addEventListener('input', (e) => {
            const value = e.target.value.trim();
            
            if (value.length === 0) {
                e.target.style.borderColor = '#f56565';
                this.showFieldError('book-title', '請輸入書名');
            } else {
                e.target.style.borderColor = '#e2e8f0';
                this.hideFieldError('book-title');
            }
            });
        }
    }

    // 顯示欄位錯誤提示
    showFieldError(fieldId, message) {
        const field = document.getElementById(fieldId);
        let errorDiv = field.parentNode.querySelector('.field-error');
        
        if (!errorDiv) {
            errorDiv = document.createElement('div');
            errorDiv.className = 'field-error';
            field.parentNode.appendChild(errorDiv);
        }
        
        errorDiv.textContent = message;
        errorDiv.style.color = '#f56565';
        errorDiv.style.fontSize = '0.8rem';
        errorDiv.style.marginTop = '5px';
    }

    // 隱藏欄位錯誤提示
    hideFieldError(fieldId) {
        const field = document.getElementById(fieldId);
        const errorDiv = field.parentNode.querySelector('.field-error');
        
        if (errorDiv) {
            errorDiv.remove();
        }
    }

    // 從書碼取得類別
    getGenreFromId(id) {
        const firstChar = id.charAt(0).toUpperCase();
        const genreMap = {
            'A': '繪本',
            'B': '橋梁書',
            'C': '文字書'
        };
        return genreMap[firstChar] || '未知';
    }

    // 智能書名排序：讓相似書名聚集在一起
    smartTitleSort(titleA, titleB, sortOrder) {
        // 提取書名的主要部分（去除數字、括號等）
        const cleanTitleA = this.cleanTitle(titleA);
        const cleanTitleB = this.cleanTitle(titleB);
        
        // 先按清理後的書名排序
        const cleanCompare = cleanTitleA.localeCompare(cleanTitleB, 'zh-TW');
        
        if (cleanCompare !== 0) {
            return sortOrder === 'asc' ? cleanCompare : -cleanCompare;
        }
        
        // 如果清理後的書名相同，則按完整書名排序
        const fullCompare = titleA.localeCompare(titleB, 'zh-TW');
        return sortOrder === 'asc' ? fullCompare : -fullCompare;
    }

    // 清理書名：移除數字、括號等，保留主要書名
    cleanTitle(title) {
        // 移除常見的後綴模式
        return title
            .replace(/[（(].*?[）)]/g, '') // 移除括號內容
            .replace(/\d+.*$/g, '') // 移除末尾的數字
            .replace(/[第].*?[卷冊部集]/g, '') // 移除第X卷/冊/部/集
            .replace(/[上下中].*$/g, '') // 移除上/下/中
            .replace(/[全].*$/g, '') // 移除全
            .replace(/[一二三四五六七八九十百千萬]+/g, '') // 移除中文數字
            .replace(/[IVXLC]+/g, '') // 移除羅馬數字
            .trim();
    }

    // 排序書籍，讓同系列書籍排在一起
    sortBooksWithSeries(books, sortOrder = 'asc') {
        // 為每本書添加清理後的書名和系列標記
        const booksWithSeriesInfo = books.map(book => ({
            ...book,
            cleanTitle: this.cleanTitle(book.title),
            hasSeriesMarkers: /[（(].*?[）)]|\d+.*$|[第].*?[卷冊部集]|[上下中].*$|[全].*$/.test(book.title)
        }));
        
        // 按系列分組
        const seriesMap = new Map();
        const standaloneBooks = [];
        
        booksWithSeriesInfo.forEach(book => {
            if (book.hasSeriesMarkers && book.cleanTitle.length > 0) {
                if (!seriesMap.has(book.cleanTitle)) {
                    seriesMap.set(book.cleanTitle, []);
                }
                seriesMap.get(book.cleanTitle).push(book);
            } else {
                standaloneBooks.push(book);
            }
        });
        
        const sortedBooks = [];
        
        // 處理系列書籍（至少2本才算系列）
        seriesMap.forEach((seriesBooks, seriesName) => {
            if (seriesBooks.length >= 2) {
                // 按書名排序系列內的書籍（尊重升冪/降冪）
                seriesBooks.sort((a, b) => this.smartTitleSort(a.title, b.title, sortOrder));
                sortedBooks.push(...seriesBooks);
            } else {
                // 單本書籍加入獨立書籍
                standaloneBooks.push(...seriesBooks);
            }
        });

        // 獨立書籍也按書名排序，避免打亂目前排序
        standaloneBooks.sort((a, b) => this.smartTitleSort(a.title, b.title, sortOrder));
        sortedBooks.push(...standaloneBooks);
        
        return sortedBooks;
    }

    // 匯入書籍
    importBooks(event) {
        if (!this.requireAdmin('匯入 Excel 書單')) return;
        const file = event.target.files[0];
        if (!file) return;

        const reader = new FileReader();
        reader.onload = (e) => {
            try {
                const data = new Uint8Array(e.target.result);
                const workbook = XLSX.read(data, { type: 'array' });
                const sheetName = workbook.SheetNames[0];
                const worksheet = workbook.Sheets[sheetName];
                const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });

                this.processImportData(jsonData);
            } catch (error) {
                this.showToast('檔案格式錯誤', 'error');
                console.error('Import error:', error);
            }
        };
        reader.readAsArrayBuffer(file);
    }

    // 處理匯入資料
    processImportData(data) {
        let successCount = 0;
        let errorCount = 0;
        const errors = [];

        // 跳過標題行，從第二行開始處理
        for (let i = 1; i < data.length; i++) {
            const row = data[i];
            if (!row || row.length === 0 || !row[0]) continue;

            const id = row[0].toString().trim();
            const title = row[1] ? row[1].toString().trim() : '';
            const copies = row[2] ? parseInt(row[2]) : this.settings.defaultCopies;

            // 驗證書碼格式
            if (!/^[ABC]\d+$/.test(id)) {
                errors.push(`第${i+1}行：書碼格式錯誤 (${id})`);
                errorCount++;
                continue;
            }

            // 檢查重複書碼
            if (this.books.find(book => book.id === id)) {
                errors.push(`第${i+1}行：書碼重複 (${id})`);
                errorCount++;
                continue;
            }

            if (!title) {
                errors.push(`第${i+1}行：缺少書名`);
                errorCount++;
                continue;
            }

            const genre = this.getGenreFromId(id);
            const year = this.settings.defaultYear;

            const newBook = {
                id,
                title,
                genre,
                year,
                copies: copies || this.settings.defaultCopies,
                availableCopies: copies || this.settings.defaultCopies
            };

            this.books.push(newBook);
            successCount++;
        }

        this.saveData();
        this.renderBooks();
        this.updateStats();

        if (successCount > 0) {
            this.showToast(`成功匯入 ${successCount} 本書籍`, 'success');
        }
        if (errorCount > 0) {
            this.showToast(`有 ${errorCount} 筆資料匯入失敗`, 'warning');
            console.log('Import errors:', errors);
        }
    }

    // 借閱書籍
    borrowBook(bookId) {
        console.log('借閱按鈕被點擊，書碼:', bookId);
        console.log('當前使用者:', this.currentUser);
        
        if (!this.currentUser) {
            this.showToast('請先登入', 'error');
            return;
        }

        if (this.currentUser.role === 'guest' && !this.settings.guestBorrow) {
            this.showToast('訪客無法借閱書籍', 'error');
            return;
        }

        const book = this.books.find(b => b.id === bookId);
        if (!book) {
            this.showToast('書籍不存在', 'error');
            return;
        }

        if (book.availableCopies <= 0) {
            this.showToast('此書籍已全部借出', 'error');
            return;
        }

        // 允許同一使用者借多本（若館藏有多本），但最多不超過該書總冊數
        const userBorrowedCount = this.borrowedBooks.filter(
            b => b.bookId === bookId && b.userId === this.currentUser.username && !b.returnedAt
        ).length;
        if (userBorrowedCount >= (book.copies || 1)) {
            this.showToast('您已借滿此書所有冊數', 'error');
            return;
        }

        const borrowDate = new Date();
        
        // 檢查使用者是否有個人化的借閱時間設定
        const userLoanSetting = this.getUserLoanSetting(this.currentUser.username);
        const loanDays = userLoanSetting ? userLoanSetting.days : this.settings.loanDays;
        const dueDate = new Date(borrowDate.getTime() + loanDays * 24 * 60 * 60 * 1000);

        const borrowRecord = {
            id: Date.now().toString(),
            bookId,
            bookTitle: book.title,
            userId: this.currentUser.username,
            borrowDate: borrowDate.toISOString(),
            dueDate: dueDate.toISOString(),
            returnedAt: null
        };

        this.borrowedBooks.push(borrowRecord);
        book.availableCopies--;

        this.saveData();
        // 所有使用者：只要借閱成功就自動上傳到 Google Sheets
        this.scheduleAutoSync();
        this.pushToGoogleSheetsNow();
        this.renderBooks();
        this.renderBorrowedBooks();
        this.updateStats();
        this.showToast('借閱成功！', 'success');
    }

    // 歸還書籍
    returnBook(borrowId) {
        const borrowRecord = this.borrowedBooks.find(b => b.id === borrowId);
        if (!borrowRecord) {
            this.showToast('借閱記錄不存在', 'error');
            return;
        }

        if (borrowRecord.returnedAt) {
            this.showToast('此書籍已歸還', 'error');
            return;
        }

        borrowRecord.returnedAt = new Date().toISOString();
        
        const book = this.books.find(b => b.id === borrowRecord.bookId);
        if (book) {
            book.availableCopies++;
        }

        this.saveData();
        // 所有使用者：只要歸還成功也自動上傳到 Google Sheets
        this.scheduleAutoSync();
        this.pushToGoogleSheetsNow();
        this.renderBooks();
        this.renderBorrowedBooks();
        this.updateStats();
        this.showToast('歸還成功！', 'success');
    }

    // 渲染書籍列表
    renderBooks() {
        console.log('開始渲染書籍，當前書籍數量:', this.books.length);
        const container = document.getElementById('books-container');
        const rawSearchTerm = document.getElementById('search-input').value;
        const normalizedSearchTerm = (rawSearchTerm || '').trim();
        const searchTerm = normalizedSearchTerm.toLowerCase();
        const genreFilter = document.getElementById('genre-filter').value;
        const sortBy = document.getElementById('sort-by').value;
        const sortOrder = document.getElementById('sort-order').value;

        // 書碼精準搜尋：支援多個書碼（逗號/空白分隔）
        const codeTokens = (normalizedSearchTerm || '')
            .toUpperCase()
            .split(/[\s,，]+/)
            .map(s => s.trim())
            .filter(Boolean);
        const isCodeSearch = codeTokens.length > 0 && codeTokens.every(t => /^[ABC]\d+$/.test(t));

        let filteredBooks = this.books.filter(book => {
            let matchesSearch;

            if (!searchTerm) {
                matchesSearch = true;
            } else if (isCodeSearch) {
                const mainId = String(book.id || '').toUpperCase();
                const allIds = Array.isArray(book.bookIds)
                    ? book.bookIds.map(id => String(id || '').toUpperCase())
                    : [];
                matchesSearch = codeTokens.some(code => code === mainId || allIds.includes(code));
            } else {
                matchesSearch =
                    String(book.title || '').toLowerCase().includes(searchTerm) ||
                    String(book.author || '').toLowerCase().includes(searchTerm) ||
                    String(book.id || '').toLowerCase().includes(searchTerm) ||
                    (book.bookIds && book.bookIds.some(id => String(id || '').toLowerCase().includes(searchTerm))) ||
                    String(book.year ?? '').toLowerCase().includes(searchTerm) ||
                    String(book.genre || '').toLowerCase().includes(searchTerm);
            }
            
            const matchesGenre = !genreFilter || this.matchesBookGenre(book, genreFilter);
            
            return matchesSearch && matchesGenre;
        });

        // 注意：排序要在「合併」後再套用，避免合併後順序被打亂

        if (filteredBooks.length === 0) {
            container.innerHTML = `
                <div class="empty-state">
                    <i class="fas fa-book-open"></i>
                    <h3>沒有找到書籍</h3>
                    <p>請嘗試調整搜尋條件或新增書籍</p>
                    <div class="empty-state-actions">
                        <button class="btn btn-primary" onclick="library.searchBookInfo('${searchTerm}')">
                            <i class="fas fa-search"></i> 搜尋書籍資訊
                        </button>
                        ${this.isAdminUser() ? `
                        <button class="btn btn-info" onclick="library.showAddBookModal()">
                            <i class="fas fa-plus"></i> 新增書籍
                        </button>` : ''}
                    </div>
                </div>
            `;
            return;
        }

        const isGridView = document.getElementById('grid-view').classList.contains('active');
        container.className = isGridView ? 'books-grid' : 'books-list';
        
        // 合併相同書名的書籍
        const mergedBooks = this.mergeBooksByTitle(filteredBooks);

        // 合併後排序
        mergedBooks.sort((a, b) => {
            if (sortBy === 'code') {
                const aCode = String(a.id || '').toUpperCase();
                const bCode = String(b.id || '').toUpperCase();
                const aMatch = aCode.match(/^([ABC])(\d+)$/);
                const bMatch = bCode.match(/^([ABC])(\d+)$/);

                if (aMatch && bMatch) {
                    const [, aLetter, aNumStr] = aMatch;
                    const [, bLetter, bNumStr] = bMatch;

                    if (aLetter !== bLetter) {
                        return sortOrder === 'asc'
                            ? aLetter.localeCompare(bLetter)
                            : bLetter.localeCompare(aLetter);
                    }

                    const aNum = parseInt(aNumStr, 10);
                    const bNum = parseInt(bNumStr, 10);
                    if (!isNaN(aNum) && !isNaN(bNum)) {
                        return sortOrder === 'asc' ? aNum - bNum : bNum - aNum;
                    }
                    return sortOrder === 'asc'
                        ? aNumStr.localeCompare(bNumStr)
                        : bNumStr.localeCompare(aNumStr);
                }

                return sortOrder === 'asc'
                    ? aCode.localeCompare(bCode)
                    : bCode.localeCompare(aCode);
            }

            // 其他排序方式：首先按類別分組
            const genreOrder = ['繪本', '橋梁書', '文字書'];
            const aGenreIndex = genreOrder.indexOf(a.genre);
            const bGenreIndex = genreOrder.indexOf(b.genre);
            if (aGenreIndex !== bGenreIndex) {
                return aGenreIndex - bGenreIndex;
            }

            // 然後按主要排序條件排序
            let aVal = a[sortBy];
            let bVal = b[sortBy];
            if (sortBy === 'year') {
                aVal = parseInt(aVal);
                bVal = parseInt(bVal);
            } else if (sortBy === 'title') {
                return this.smartTitleSort(a.title, b.title, sortOrder);
            } else {
                aVal = aVal.toString().toLowerCase();
                bVal = bVal.toString().toLowerCase();
            }

            if (sortOrder === 'asc') {
                return aVal > bVal ? 1 : -1;
            }
            return aVal < bVal ? 1 : -1;
        });

        // 只有在「按書名排序」時才做系列聚集，避免覆蓋書碼排序
        const sortedBooks = sortBy === 'title'
            ? this.sortBooksWithSeries(mergedBooks, sortOrder)
            : mergedBooks;
        
        container.innerHTML = sortedBooks.map(book => this.createBookCard(book)).join('');
    }

    // 合併相同書名的書籍
    mergeBooksByTitle(books) {
        const titleMap = new Map();
        
        books.forEach(book => {
            const normalizedTitle = this.normalizeTitle(book.title);
            
            if (!titleMap.has(normalizedTitle)) {
                // 創建合併後的書籍對象
                const mergedBook = {
                    ...book,
                    bookIds: [book.id],
                    mergedBooks: [book],
                    totalCopies: book.copies || 1,
                    totalAvailableCopies: book.availableCopies || 0,
                    // 新書標記：合併卡片沿用最新 addedAt
                    isNew: !!book.isNew,
                    addedAt: book.addedAt || null
                };
                titleMap.set(normalizedTitle, mergedBook);
            } else {
                // 合併到現有的書籍
                const existingBook = titleMap.get(normalizedTitle);
                existingBook.bookIds.push(book.id);
                existingBook.mergedBooks.push(book);
                existingBook.totalCopies += (book.copies || 1);
                existingBook.totalAvailableCopies += (book.availableCopies || 0);

                // 新書標記：只要其中一本是新書就標記；addedAt 取最新
                if (book.isNew) existingBook.isNew = true;
                const existingAddedAt = existingBook.addedAt || 0;
                const nextAddedAt = book.addedAt || 0;
                if (nextAddedAt > existingAddedAt) existingBook.addedAt = nextAddedAt;
                
                // 更新主要資訊（使用第一本書的資訊）
                if (!existingBook.author && book.author) {
                    existingBook.author = book.author;
                }
                if (!existingBook.coverUrl && book.coverUrl) {
                    existingBook.coverUrl = book.coverUrl;
                }
                if (!existingBook.year && book.year) {
                    existingBook.year = book.year;
                }
            }
        });
        
        return Array.from(titleMap.values());
    }

    // 標準化書名（用於比較）
    normalizeTitle(title) {
        if (!title) return '';
        return title
            .toLowerCase()
            .trim()
            .replace(/[^\u4e00-\u9fa5a-zA-Z0-9\s]/g, '') // 保留中文、英文、數字和空格
            .replace(/\s+/g, ' ') // 合併多個空格
            .trim();
    }

    // 根據書編號自動分類匹配
    matchesBookGenre(book, genreFilter) {
        // 以主書碼 book.id 的前綴為準，避免合併書卡因含其他前綴而被放行
        const mainCode = String(book.id || '').toUpperCase();
        const mainMatch = mainCode.match(/^([ABC])(\d+)$/);
        if (mainMatch) {
            const prefix = mainMatch[1];
            switch (prefix) {
                case 'A':
                    return genreFilter === '繪本';
                case 'B':
                    return genreFilter === '橋梁書';
                case 'C':
                    return genreFilter === '文字書';
                default:
                    return false;
            }
        }

        // 主書碼不合法時，才回退檢查 bookIds（例如舊資料/合併資料）
        const allCodes = Array.isArray(book.bookIds)
            ? book.bookIds.map(v => String(v || '').toUpperCase()).filter(Boolean)
            : [];

        const prefixes = allCodes
            .map(code => code.match(/^([ABC])(\d+)$/))
            .filter(Boolean)
            .map(m => m[1]);

        if (prefixes.length > 0) {
            return prefixes.some(prefix => {
                switch (prefix) {
                    case 'A':
                        return genreFilter === '繪本';
                    case 'B':
                        return genreFilter === '橋梁書';
                    case 'C':
                        return genreFilter === '文字書';
                    default:
                        return false;
                }
            });
        }

        // 如果書碼格式都不正確，最後才使用原有類別判斷
        return book.genre === genreFilter;
    }

    // 判斷是否為國小四年級適合的書籍
    isElementaryGrade4Book(book, genreFilter) {
        // 如果已設定類別，直接檢查
        if (book.genre) {
            return book.genre === genreFilter;
        }

        // 根據書名和作者判斷是否適合國小四年級
        const title = String(book.title || '').toLowerCase();
        const author = String(book.author || '').toLowerCase();
        const year = parseInt(book.year) || 0;
        
        // 適合國小四年級的類別
        const suitableGenres = ['橋梁書', '童話', '冒險', '科普', '傳記', '歷史', '文學'];
        
        // 檢查是否在適合的類別中
        if (suitableGenres.includes(genreFilter)) {
            return true;
        }
        
        // 根據書名關鍵字判斷
        const grade4Keywords = [
            '小學', '國小', '四年級', '童話', '故事', '冒險', 
            '科學', '自然', '歷史', '地理', '傳記', '神話',
            '寓言', '成語', '古詩', '經典', '名著', '兒童'
        ];
        
        const hasGrade4Keyword = grade4Keywords.some(keyword => 
            title.includes(keyword) || author.includes(keyword)
        );
        
        if (hasGrade4Keyword) {
            return true;
        }
        
        // 根據出版年份判斷（較新的書籍通常更適合）
        if (year >= 2000 && suitableGenres.includes(genreFilter)) {
            return true;
        }
        
        return false;
    }

    // 從編輯模態框搜尋書籍資訊
    searchBookInfoFromEdit() {
        const titleInput = document.getElementById('edit-book-title');
        const searchTerm = titleInput.value.trim();
        
        if (!searchTerm) {
            this.showToast('請先輸入書名再進行搜尋', 'warning');
            titleInput.focus();
            return;
        }

        // 直接顯示多選搜尋選項
        this.showMultiSearchOptions(searchTerm);
    }

    // 建立書籍卡片
    createBookCard(book) {
        // 判斷是否為合併書籍
        const isMerged = book.mergedBooks && book.mergedBooks.length > 1;

        // 新增書籍記號（7天內視為新書）
        const addedAt = Number(book.addedAt) || 0;
        const isNew = !!book.isNew && addedAt > 0 && (Date.now() - addedAt) <= 7 * 24 * 60 * 60 * 1000;
        
        // 計算可借閱數量（使用合併後的數量）
        const availableCopies = isMerged ? book.totalAvailableCopies : (book.availableCopies || 0);
        const totalCopies = isMerged ? book.totalCopies : (book.copies || 1);
        
        const canBorrow = this.currentUser && 
            (this.currentUser.role !== 'guest' || this.settings.guestBorrow) &&
            availableCopies > 0;

        // 計算用戶已借閱數量（需要檢查所有合併的書籍）
        let userBorrowedCount = 0;
        if (this.currentUser) {
            if (isMerged) {
                userBorrowedCount = book.mergedBooks.reduce((count, mergedBook) => {
                    return count + this.borrowedBooks.filter(
                        b => b.bookId === mergedBook.id && b.userId === this.currentUser.username && !b.returnedAt
                    ).length;
                }, 0);
            } else {
                userBorrowedCount = this.borrowedBooks.filter(
                    b => b.bookId === book.id && b.userId === this.currentUser.username && !b.returnedAt
                ).length;
            }
        }

        // 顯示書碼資訊
        const bookIdsDisplay = isMerged 
            ? `${book.id} 等${book.bookIds.length}本` 
            : book.id;

        const canManageBooks = this.isAdminUser();

        return `
            <div class="book-card genre-${book.genre} ${availableCopies === 0 ? 'borrowed' : ''} ${isMerged ? 'merged' : ''}">
                <div class="book-cover">
                    ${book.coverUrl ? 
                        `<img src="${book.coverUrl}" alt="${book.title}" class="book-cover-img" onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
                        <div class="book-cover-placeholder" style="display: none;">
                            <i class="fas fa-book"></i>
                        </div>` : 
                        `<img src="https://i.pinimg.com/736x/74/7e/34/747e34277959ed78812cbdee95715c5e.jpg" alt="${book.title}" class="book-cover-img" onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
                        <div class="book-cover-placeholder" style="display: none;">
                            <i class="fas fa-book"></i>
                        </div>`
                    }
                    ${isMerged ? '<div class="merged-badge">合併</div>' : ''}
                    ${isNew ? '<div class="new-badge">新</div>' : ''}
                </div>
                <div class="book-content">
                    <div class="book-header">
                        <span class="book-id">${bookIdsDisplay}</span>
                        <span class="book-genre">${book.genre}</span>
                    </div>
                    <div class="book-title">${book.title}</div>
                    ${book.author ? `<div class="book-info-item"><i class=\"fas fa-pen-nib\"></i><span>${book.author}</span></div>` : ''}
                    <div class="book-info">
                        <div class="book-info-item">
                            <i class="fas fa-calendar"></i>
                            <span>${book.year}年</span>
                        </div>
                        <div class="book-info-item">
                            <i class="fas fa-copy"></i>
                            <span>可借 ${availableCopies}/${totalCopies} 本</span>
                        </div>
                        ${isMerged ? `
                        <div class="book-info-item">
                            <i class="fas fa-layer-group"></i>
                            <span>包含 ${book.mergedBooks.length} 本書</span>
                        </div>` : ''}
                        ${isMerged ? `
                        <div class="book-info-item">
                            <i class="fas fa-list"></i>
                            <span>書碼：${book.bookIds.join(', ')}</span>
                        </div>` : ''}
                    </div>
                    <div class="book-actions">
                        ${canBorrow ? 
                            `<button class="btn btn-primary btn-small" onclick="library.borrowBook('${book.id}')">
                                <i class="fas fa-book-reader"></i> ${userBorrowedCount > 0 ? '再借' : '借閱'}
                            </button>` : 
                            `<button class="btn btn-outline btn-small" disabled>
                                <i class="fas fa-ban"></i> 無法借閱
                            </button>`
                        }
                        ${canManageBooks ? `
                            <button class="btn btn-info btn-small" onclick="library.showEditBookModal('${book.id}')">
                                <i class="fas fa-pen"></i> 編輯
                            </button>
                            <button class="btn btn-warning btn-small" onclick="library.deleteBook('${book.id}')">
                                <i class="fas fa-trash"></i> 刪除
                            </button>
                        ` : ''}
                    </div>
                </div>
            </div>
        `;
    }

    showEditBookModal(bookId) {
        if (!this.requireAdmin('編輯書籍')) return;

        const book = this.books.find(b => b.id === bookId);
        if (!book) {
            this.showToast('書籍不存在', 'error');
            return;
        }

        const modal = document.getElementById('edit-book-modal');
        const originalIdInput = document.getElementById('edit-book-original-id');
        const idInput = document.getElementById('edit-book-id');
        const titleInput = document.getElementById('edit-book-title');
        const authorInput = document.getElementById('edit-book-author');
        const coverInput = document.getElementById('edit-book-cover-url');
        const yearInput = document.getElementById('edit-book-year');
        const copiesInput = document.getElementById('edit-book-copies');

        if (originalIdInput) originalIdInput.value = book.id;
        if (idInput) idInput.value = book.id;
        if (titleInput) titleInput.value = book.title || '';
        if (authorInput) authorInput.value = book.author || '';
        if (coverInput) coverInput.value = book.coverUrl || '';
        if (yearInput) yearInput.value = book.year || this.settings.defaultYear;
        if (copiesInput) copiesInput.value = book.copies || 1;

        if (modal) modal.style.display = 'block';

        // 自動搜尋書籍資料
        this.autoSearchBookInfo(book.title);
    }

    // 自動搜尋書籍資料（編輯時使用）
    async autoSearchBookInfo(bookTitle) {
        if (!bookTitle || bookTitle.trim() === '') return;

        try {
            // 使用 Google Books API 搜尋
            const query = encodeURIComponent(bookTitle.trim());
            const apiUrl = `https://www.googleapis.com/books/v1/volumes?q=${query}&maxResults=1&langRestrict=zh`;

            const response = await fetch(apiUrl);
            if (!response.ok) return;

            const data = await response.json();
            
            if (!data.items || data.items.length === 0) return;

            const book = data.items[0];
            const info = book.volumeInfo;

            // 檢查是否需要更新現有資料
            const authorInput = document.getElementById('edit-book-author');
            const coverInput = document.getElementById('edit-book-cover-url');
            const yearInput = document.getElementById('edit-book-year');

            let hasUpdates = false;
            let updateMessage = '找到書籍資訊：';

            // 更新作者（如果目前為空）
            if (authorInput && (!authorInput.value || authorInput.value.trim() === '') && info.authors) {
                authorInput.value = info.authors.join(', ');
                hasUpdates = true;
                updateMessage += ' 作者已更新';
            }

            // 更新封面（如果目前為空）
            if (coverInput && (!coverInput.value || coverInput.value.trim() === '') && info.imageLinks) {
                const coverUrl = info.imageLinks.extraLarge || 
                                info.imageLinks.large || 
                                info.imageLinks.medium || 
                                info.imageLinks.thumbnail || 
                                info.imageLinks.smallThumbnail;
                if (coverUrl) {
                    coverInput.value = coverUrl;
                    hasUpdates = true;
                    updateMessage += ' 封面已更新';
                }
            }

            // 更新年份（如果目前為預設值且找到更準確的年份）
            if (yearInput && info.publishedDate) {
                const publishedYear = info.publishedDate.substring(0, 4);
                const currentYear = yearInput.value;
                const defaultYear = this.settings.defaultYear;
                
                if (currentYear == defaultYear && publishedYear !== currentYear) {
                    yearInput.value = publishedYear;
                    hasUpdates = true;
                    updateMessage += ' 年份已更新';
                }
            }

            // 顯示更新結果
            if (hasUpdates) {
                this.showToast(updateMessage, 'success');
            }

        } catch (error) {
            console.error('自動搜尋書籍資訊失敗:', error);
            // 靜默失敗，不影響編輯功能
        }
    }

    handleEditBook(e) {
        e.preventDefault();
        if (!this.requireAdmin('編輯書籍')) return;

        const originalId = (document.getElementById('edit-book-original-id')?.value || '').trim();
        const title = (document.getElementById('edit-book-title')?.value || '').trim();
        const author = (document.getElementById('edit-book-author')?.value || '').trim();
        const coverUrl = (document.getElementById('edit-book-cover-url')?.value || '').trim();
        const year = parseInt(document.getElementById('edit-book-year')?.value) || this.settings.defaultYear;
        const newCopies = parseInt(document.getElementById('edit-book-copies')?.value) || 1;

        if (!originalId) {
            this.showToast('編輯失敗：缺少書碼', 'error');
            return;
        }
        if (!title) {
            this.showToast('請輸入書名', 'error');
            return;
        }

        const book = this.books.find(b => b.id === originalId);
        if (!book) {
            this.showToast('書籍不存在', 'error');
            return;
        }

        const borrowedCount = this.borrowedBooks.filter(b => b.bookId === originalId && !b.returnedAt).length;
        if (newCopies < borrowedCount) {
            this.showToast(`冊數不得小於已借出數量 (${borrowedCount})`, 'error');
            return;
        }

        book.title = title;
        book.author = author;
        book.coverUrl = coverUrl;
        book.year = year;
        book.copies = newCopies;
        book.availableCopies = newCopies - borrowedCount;

        if (Array.isArray(book.bookIds) && !book.bookIds.includes(book.id)) {
            book.bookIds.unshift(book.id);
        }

        this.saveData();
        this.renderBooks();
        this.updateStats();

        const modal = document.getElementById('edit-book-modal');
        if (modal) modal.style.display = 'none';
        this.showToast('書籍已更新', 'success');
    }

    async autoFillBookInfo({ titleInputId, authorInputId, yearInputId, coverInputId }) {
        const titleInput = document.getElementById(titleInputId);
        const authorInput = document.getElementById(authorInputId);
        const yearInput = document.getElementById(yearInputId);
        const coverInput = coverInputId ? document.getElementById(coverInputId) : null;

        const title = (titleInput?.value || '').trim();
        const author = (authorInput?.value || '').trim();

        if (!title && !author) {
            this.showToast('請先輸入書名或作者再搜尋', 'warning');
            return;
        }

        try {
            const q = [];
            if (title) q.push(`intitle:${title}`);
            if (author) q.push(`inauthor:${author}`);
            const url = `https://www.googleapis.com/books/v1/volumes?q=${encodeURIComponent(q.join('+'))}&maxResults=5`;

            // 使用 API 隊列機制
            const data = await this.enqueueApiRequest(async () => {
                return await this.fetchWithRetry(url);
            });
            
            const item = data?.items?.[0];
            const info = item?.volumeInfo;
            if (!info) {
                this.showToast('找不到符合的書籍資料', 'warning');
                return;
            }

            const foundTitle = (info.title || '').trim();
            const foundAuthors = Array.isArray(info.authors) ? info.authors.join('、') : '';
            const published = (info.publishedDate || '').trim();
            const year = published ? parseInt(published.slice(0, 4), 10) : NaN;
            const coverUrl = (info.imageLinks?.thumbnail || info.imageLinks?.smallThumbnail || '').trim();

            if (titleInput && foundTitle && !titleInput.value.trim()) titleInput.value = foundTitle;
            if (authorInput && foundAuthors) authorInput.value = foundAuthors;
            if (yearInput && Number.isFinite(year)) yearInput.value = String(year);
            if (coverInput && coverUrl) coverInput.value = coverUrl;

            this.showToast('已自動回填書籍資訊', 'success');
        } catch (error) {
            console.error('autoFillBookInfo error:', error);
            this.handleApiError(error, '自動填入書籍資訊失敗');
        }
    }

    // API 請求隊列處理
    async enqueueApiRequest(requestFn) {
        return new Promise((resolve, reject) => {
            this.apiRequestQueue.push({ requestFn, resolve, reject });
            this.processApiQueue();
        });
    }

    async processApiQueue() {
        if (this.apiRequestInProgress || this.apiRequestQueue.length === 0) return;
        
        this.apiRequestInProgress = true;
        
        while (this.apiRequestQueue.length > 0) {
            const { requestFn, resolve, reject } = this.apiRequestQueue.shift();
            
            // 確保請求間隔
            const now = Date.now();
            const timeSinceLastRequest = now - this.lastApiRequestTime;
            if (timeSinceLastRequest < this.apiRequestDelay) {
                const waitTime = this.apiRequestDelay - timeSinceLastRequest;
                await new Promise(r => setTimeout(r, waitTime));
            }
            
            this.lastApiRequestTime = Date.now();
            
            try {
                const result = await requestFn();
                resolve(result);
            } catch (error) {
                reject(error);
            }
        }
        
        this.apiRequestInProgress = false;
    }

    // 帶重試與指數退避的 fetch
    async fetchWithRetry(url, options = {}) {
        let lastError;
        for (let attempt = 1; attempt <= this.apiRetryConfig.maxRetries; attempt++) {
            try {
                const res = await fetch(url, options);
                if (res.ok) return await res.json();
                if (res.status === 429) {
                    // 429: Too Many Requests，使用更長的固定延遲
                    const delay = Math.min(
                        this.apiRetryConfig.baseDelay * attempt, // 線性增長而不是指數
                        this.apiRetryConfig.maxDelay
                    );
                    console.warn(`API 429，等待 ${delay}ms 後重試 (${attempt}/${this.apiRetryConfig.maxRetries})`);
                    await new Promise(resolve => setTimeout(resolve, delay));
                    continue;
                }
                throw new Error(`HTTP ${res.status}`);
            } catch (err) {
                lastError = err;
                if (attempt === this.apiRetryConfig.maxRetries) break;
                const delay = Math.min(
                    this.apiRetryConfig.baseDelay * Math.pow(2, attempt - 1),
                    this.apiRetryConfig.maxDelay
                );
                console.warn(`API 請求失敗，等待 ${delay}ms 後重試 (${attempt}/${this.apiRetryConfig.maxRetries})`, err.message);
                await new Promise(resolve => setTimeout(resolve, delay));
            }
        }
        throw lastError;
    }

    // 統一的 API 錯誤處理
    handleApiError(error, fallbackMessage = 'API 請求失敗') {
        if (error.message.includes('429')) {
            this.showToast('請求過於頻繁，請等待 10-20 秒後再試', 'error');
        } else if (error.message.includes('499') || error.message.includes('antivirus')) {
            this.showToast('請求被防毒軟體阻擋，請暫時停用防毒或換網路', 'error');
        } else if (error.message.includes('Failed to fetch') || error.message.includes('NetworkError')) {
            this.showToast('網路連線異常，請檢查網路狀態', 'error');
        } else {
            this.showToast(fallbackMessage, 'error');
        }
    }

    deleteBook(bookId) {
        if (!this.requireAdmin('刪除書籍')) return;

        const book = this.books.find(b => b.id === bookId);
        if (!book) {
            this.showToast('書籍不存在', 'error');
            return;
        }

        const borrowedCount = this.borrowedBooks.filter(b => b.bookId === bookId && !b.returnedAt).length;
        if (borrowedCount > 0) {
            this.showToast('此書籍仍有未歸還借閱，無法刪除', 'error');
            return;
        }

        if (!confirm(`確定要刪除「${book.title}」嗎？`)) return;

        this.books = this.books.filter(b => b.id !== bookId);
        this.saveData();
        this.renderBooks();
        this.updateStats();
        this.showToast('書籍已刪除', 'success');
    }

    // 渲染借閱記錄
    renderBorrowedBooks() {
        const container = document.getElementById('borrowed-container');
        
        if (!this.currentUser) {
            container.innerHTML = `
                <div class="empty-state">
                    <i class="fas fa-sign-in-alt"></i>
                    <h3>請先登入</h3>
                    <p>登入後即可查看借閱記錄</p>
                </div>
            `;
            return;
        }

        // 根據使用者角色決定顯示範圍
        let borrowedBooks;
        if (this.isAdminUser()) {
            // 只有管理員可以看到所有借閱記錄
            borrowedBooks = this.borrowedBooks.filter(b => !b.returnedAt);
        } else {
            // 其他使用者（包括老師/館員、學生、訪客）只能看到自己的借閱記錄
            borrowedBooks = this.borrowedBooks.filter(
                b => b.userId === this.currentUser.username && !b.returnedAt
            );
        }

        if (borrowedBooks.length === 0) {
            const message = this.isAdminUser() 
                ? '目前沒有借閱記錄' 
                : '您目前沒有借閱記錄';
            const subMessage = this.isAdminUser()
                ? '所有書籍都已歸還'
                : '快去借閱您喜歡的書籍吧！';
                
            container.innerHTML = `
                <div class="empty-state">
                    <i class="fas fa-book"></i>
                    <h3>${message}</h3>
                    <p>${subMessage}</p>
                </div>
            `;
            return;
        }

        container.innerHTML = borrowedBooks.map(record => this.createBorrowedItem(record)).join('');
    }

    // 建立借閱項目
    createBorrowedItem(record) {
        const borrowDate = new Date(record.borrowDate);
        const dueDate = new Date(record.dueDate);
        const now = new Date();
        const daysLeft = Math.ceil((dueDate - now) / (1000 * 60 * 60 * 24));

        // 檢查當前使用者是否有管理員權限
        const isAdmin = this.isAdminUser();
        
        // 獲取使用者的借閱時間設定
        const userLoanSetting = this.getUserLoanSetting(record.userId);
        const currentLoanDays = userLoanSetting ? userLoanSetting.days : this.settings.loanDays;

        return `
            <div class="borrowed-item">
                <div class="borrowed-info">
                    <div class="borrowed-title">${record.bookTitle}</div>
                    <div class="borrowed-details">
                        <div><i class="fas fa-user"></i> 借閱者：${record.userId}</div>
                        <div><i class="fas fa-calendar-plus"></i> 借閱日期：${borrowDate.toLocaleDateString()}</div>
                        <div><i class="fas fa-calendar-check"></i> 應還日期：${dueDate.toLocaleDateString()}</div>
                        <div>
                            <i class="fas fa-clock"></i> 剩餘 ${daysLeft} 天
                            ${userLoanSetting ? `<span class="loan-setting-badge">個人設定 ${currentLoanDays}天</span>` : `<span class="loan-setting-badge">預設 ${currentLoanDays}天</span>`}
                        </div>
                    </div>
                </div>
                <div class="borrowed-actions">
                    ${isAdmin ? `
                        <button class="btn btn-info btn-small" onclick="library.editUserLoanFromBorrowed('${record.userId}')" title="修改借閱時間設定">
                            <i class="fas fa-user-clock"></i> 設定時間
                        </button>
                    ` : ''}
                    <button class="btn btn-success btn-small" onclick="library.returnBook('${record.id}')">
                        <i class="fas fa-undo"></i> 歸還
                    </button>
                </div>
            </div>
        `;
    }

    // 更新統計資訊
    updateStats() {
        const totalBooks = this.books.reduce((sum, book) => sum + book.copies, 0);
        const uniqueTitles = this.books.length;
        const availableBooks = this.books.reduce((sum, book) => sum + book.availableCopies, 0);
        const borrowedBooks = this.borrowedBooks.filter(b => !b.returnedAt).length;

        document.getElementById('total-books').textContent = totalBooks;
        document.getElementById('unique-titles').textContent = uniqueTitles;
        document.getElementById('available-books').textContent = availableBooks;
        document.getElementById('borrowed-books').textContent = borrowedBooks;
    }

    // 設定視圖模式
    setView(view) {
        const gridBtn = document.getElementById('grid-view');
        const listBtn = document.getElementById('list-view');
        const container = document.getElementById('books-container');

        if (view === 'grid') {
            gridBtn.classList.add('active');
            listBtn.classList.remove('active');
            container.className = 'books-grid';
        } else {
            listBtn.classList.add('active');
            gridBtn.classList.remove('active');
            container.className = 'books-list';
        }
    }

    // 重置資料
    resetData() {
        if (!this.requireAdmin('重置資料')) return;
        if (confirm('確定要重置所有資料嗎？此操作無法復原！')) {
            localStorage.removeItem('lib_books_v1');
            localStorage.removeItem('lib_borrowed_v1');
            localStorage.removeItem('lib_users_v1');
            localStorage.removeItem('lib_active_user_v1');
            localStorage.removeItem('lib_settings_v1');
            localStorage.removeItem('lib_csv_loaded_v1');
            
            this.books = [];
            this.borrowedBooks = [];
            this.users = [];
            this.currentUser = null;
            
            // 重新載入 Google Sheets（改以線上資料為主）
            this.pullFromGoogleSheets({ silent: false, protectEmpty: false, closeModal: false });
            
            this.renderBooks();
            this.renderBorrowedBooks();
            this.updateStats();
            this.updateUserDisplay();
            
            this.showToast('資料已重置，將重新載入線上資料', 'success');
        }
    }
    
    // 重新載入 CSV 資料
    async reloadCSV() {
        if (!this.requireAdmin('重新載入 CSV')) return;
        
        // 嘗試從 Google Sheets 載入，失敗時自動載入本地 CSV
        this.showToast('正在嘗試從線上載入資料...', 'info');
        
        const url = this.getGoogleWebAppUrl();
        if (!url) {
            console.log('未設定 Google Sheets URL，直接載入本地 CSV');
            await this.autoLoadCSV();
            return;
        }

        try {
            await this.pullFromGoogleSheets({ silent: false, protectEmpty: false, closeModal: false });
        } catch (error) {
            console.error('從 Google Sheets 載入失敗:', error);
            this.showToast('線上載入失敗，嘗試載入本地 CSV 檔案...', 'warning');
            await this.autoLoadCSV();
        }
    }

    // 匯出書籍資料到 CSV 檔案
    async exportToCSV() {
        if (!this.requireAdmin('匯出 CSV')) return;
        
        if (this.books.length === 0) {
            this.showToast('沒有書籍資料可以匯出', 'warning');
            return;
        }

        try {
            this.showToast('正在匯出 CSV 檔案...', 'info');
            this.showLoadingIndicator(true);

            // 建立 CSV 內容
            let csvContent = '博幼藏書,\n,\n欄1,欄2\n編號,書名\n';
            
            // 按書碼排序
            const sortedBooks = [...this.books].sort((a, b) => {
                if (a.id && b.id) {
                    return a.id.localeCompare(b.id);
                }
                return (a.title || '').localeCompare(b.title || '');
            });

            // 加入書籍資料
            sortedBooks.forEach(book => {
                const id = book.id || '';
                const title = book.title || '';
                csvContent += `${id},${title}\n`;
            });

            // 建立 Blob 物件
            const blob = new Blob(['\ufeff' + csvContent], { type: 'text/csv;charset=utf-8;' });
            
            // 建立下載連結
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', '113博幼館藏.csv');
            link.style.visibility = 'hidden';
            
            // 觸發下載
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);

            this.showLoadingIndicator(false);
            this.showToast(`成功匯出 ${this.books.length} 筆書籍資料到 CSV 檔案`, 'success');
            
            console.log(`CSV 匯出完成，共 ${this.books.length} 筆資料`);

        } catch (error) {
            console.error('匯出 CSV 失敗:', error);
            this.showLoadingIndicator(false);
            this.showToast('匯出 CSV 失敗', 'error');
        }
    }

    // 同步 Google Sheets 資料到本地 CSV
    async syncGoogleSheetsToCSV() {
        if (!this.requireAdmin('同步 Google Sheets 到 CSV')) return;
        
        const url = this.getGoogleWebAppUrl();
        if (!url) {
            this.showToast('請先設定 Google Sheets 同步網址', 'error');
            return;
        }

        try {
            this.showToast('正在從 Google Sheets 載入資料...', 'info');
            this.showLoadingIndicator(true);

            const response = await fetch(url, {
                method: 'POST',
                body: JSON.stringify({ action: 'pull' })
            });

            const result = await response.json().catch(() => null);
            if (!response.ok || !result || !result.ok) {
                throw new Error('Google Sheets 請求失敗');
            }

            const data = result.data || {};
            if (!Array.isArray(data.books)) {
                throw new Error('資料格式不正確');
            }

            if (data.books.length === 0) {
                this.showLoadingIndicator(false);
                this.showToast('Google Sheets 中沒有書籍資料', 'warning');
                return;
            }

            // 更新本地書籍資料
            this.books = data.books;
            this.borrowedBooks = data.borrowedBooks || [];
            
            // 處理博幼藏書資料
            if (data.boyouBooks && typeof data.boyouBooks === 'object') {
                localStorage.setItem('lib_boyou_books_v1', JSON.stringify(data.boyouBooks));
            }

            // 儲存到本地
            this.saveData();
            
            // 匯出為 CSV
            await this.exportToCSVData(data.books);
            
            // 重新渲染介面
            this.renderBooks();
            this.renderBorrowedBooks();
            this.updateStats();
            this.lastUpdateTime = new Date();
            this.updateLastUpdateDisplay();

            this.showLoadingIndicator(false);
            this.showToast(`成功同步 ${data.books.length} 本書籍到 CSV 檔案`, 'success');

        } catch (error) {
            console.error('同步 Google Sheets 到 CSV 失敗:', error);
            this.showLoadingIndicator(false);
            this.showToast('同步失敗，請檢查網路連線或 Google Sheets 設定', 'error');
        }
    }

    // 匯出書籍資料為 CSV (內部函數)
    async exportToCSVData(books) {
        try {
            // 建立 CSV 內容
            let csvContent = '博幼藏書,\n,\n欄1,欄2\n編號,書名\n';
            
            // 按書碼排序
            const sortedBooks = [...books].sort((a, b) => {
                if (a.id && b.id) {
                    return a.id.localeCompare(b.id);
                }
                return (a.title || '').localeCompare(b.title || '');
            });

            // 加入書籍資料
            sortedBooks.forEach(book => {
                const id = book.id || '';
                const title = book.title || '';
                csvContent += `${id},${title}\n`;
            });

            // 建立 Blob 物件
            const blob = new Blob(['\ufeff' + csvContent], { type: 'text/csv;charset=utf-8;' });
            
            // 建立下載連結
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', '113博幼館藏.csv');
            link.style.visibility = 'hidden';
            
            // 觸發下載
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);

            console.log(`CSV 匯出完成，共 ${books.length} 筆資料`);

        } catch (error) {
            console.error('匯出 CSV 資料失敗:', error);
            throw error;
        }
    }


    // 開始自動更新
    startAutoUpdate() {
        if (!this.isAdminUser()) {
            this.stopAutoUpdate();
            return;
        }
        // 清除現有的定時器
        if (this.updateTimer) {
            clearInterval(this.updateTimer);
        }

        // 設定自動更新定時器
        this.updateTimer = setInterval(() => {
            this.autoUpdateBooks();
        }, this.settings.autoUpdateInterval);

        console.log(`自動更新已啟動，每 ${this.settings.autoUpdateInterval / 1000} 秒檢查一次`);
    }

    // 停止自動更新
    stopAutoUpdate() {
        if (this.updateTimer) {
            clearInterval(this.updateTimer);
            this.updateTimer = null;
            console.log('自動更新已停止');
        }
    }

    // 自動更新書籍資料
    async autoUpdateBooks() {
        try {
            console.log('開始自動更新線上 Google Sheets 資料...');

            await this.pullFromGoogleSheets({ silent: true, protectEmpty: true, closeModal: false });
            this.lastUpdateTime = new Date();
            this.updateLastUpdateDisplay();
        } catch (error) {
            console.error('自動更新失敗:', error);
        }
    }

    // 更新最後更新時間顯示
    updateLastUpdateDisplay() {
        const lastUpdateElement = document.getElementById('last-update-time');
        if (lastUpdateElement && this.lastUpdateTime) {
            const timeString = this.lastUpdateTime.toLocaleString('zh-TW');
            lastUpdateElement.textContent = `最後更新：${timeString}`;
        }
    }

    // 切換自動更新狀態
    toggleAutoUpdate() {
        if (!this.requireAdmin('自動更新')) return;
        const button = document.getElementById('toggle-auto-update-btn');
        const statusElement = document.getElementById('auto-update-status');
        
        if (this.updateTimer) {
            // 停止自動更新
            this.stopAutoUpdate();
            button.innerHTML = '<i class="fas fa-play"></i> 啟動自動更新';
            button.className = 'btn btn-warning';
            statusElement.innerHTML = '<i class="fas fa-circle" style="color: #ff6b6b;"></i> 自動更新已停止';
            this.showToast('自動更新已停止', 'warning');
        } else {
            // 啟動自動更新
            this.startAutoUpdate();
            button.innerHTML = '<i class="fas fa-pause"></i> 停止自動更新';
            button.className = 'btn btn-success';
            statusElement.innerHTML = '<i class="fas fa-circle" style="color: #28a745;"></i> 自動更新已啟動';
            this.showToast('自動更新已啟動', 'success');
        }
    }

    // 顯示載入指示器
    showLoadingIndicator(show) {
        const statusElement = document.getElementById('auto-update-status');
        if (statusElement) {
            if (show) {
                statusElement.innerHTML = '<i class="fas fa-spinner fa-spin"></i> 正在載入最新資料...';
                statusElement.style.color = '#007bff';
            } else {
                // 恢復正常狀態顯示
                if (this.updateTimer) {
                    statusElement.innerHTML = '<i class="fas fa-circle" style="color: #28a745;"></i> 自動更新已啟動';
                } else {
                    statusElement.innerHTML = '<i class="fas fa-circle" style="color: #ff6b6b;"></i> 自動更新已停止';
                }
            }
        }
    }

    // 跳轉到博幼藏書頁面
    goToBoyouBooks() {
        window.location.href = 'boyou-books.html';
    }

    // 顯示通知
    showToast(message, type = 'info') {
        const toast = document.getElementById('toast');
        toast.textContent = message;
        toast.className = `toast ${type}`;
        toast.classList.add('show');
        
        setTimeout(() => {
            toast.classList.remove('show');
        }, 3000);
    }

    // 匯出借閱清單為 Excel
    exportBorrowedToExcel() {
        if (!this.currentUser) {
            this.showToast('請先登入後再匯出', 'error');
            return;
        }

        // 依角色決定匯出內容（與畫面一致：管理員匯出全部未歸還，其餘僅匯出自己的未歸還）
        let records;
        if (this.isAdminUser()) {
            records = this.borrowedBooks.filter(b => !b.returnedAt);
        } else {
            records = this.borrowedBooks.filter(b => b.userId === this.currentUser.username && !b.returnedAt);
        }

        if (!records || records.length === 0) {
            this.showToast('沒有可匯出的借閱記錄', 'warning');
            return;
        }

        // 管理員：單一檔案、每位借閱者一個工作表
        if (this.isAdminUser()) {
            const grouped = new Map();
            records.forEach(r => {
                if (!grouped.has(r.userId)) grouped.set(r.userId, []);
                grouped.get(r.userId).push(r);
            });

            const dateStr = new Date().toISOString().slice(0, 10);
            const header = ['借閱編號', '書碼', '書名', '借閱者', '借閱日期'];

            const wb = XLSX.utils.book_new();

            const sanitizeSheetName = (name) => {
                const invalid = /[\\\/:\*\?\[\]]/g; // Excel 禁止字元
                let safe = String(name).replace(invalid, ' ');
                if (!safe.trim()) safe = '借閱者';
                if (safe.length > 31) safe = safe.slice(0, 31);
                return safe;
            };

            grouped.forEach((userRecords, userId) => {
                const rows = userRecords.map(r => {
                    const borrowDate = new Date(r.borrowDate);
                    return [
                        r.id,
                        r.bookId,
                        r.bookTitle,
                        r.userId,
                        borrowDate.toLocaleDateString('zh-TW')
                    ];
                });

                const aoa = [header, ...rows];
                const ws = XLSX.utils.aoa_to_sheet(aoa);
                const colWidths = header.map((h, idx) => {
                    const maxLen = Math.max(
                        h.length,
                        ...rows.map(row => (row[idx] !== undefined && row[idx] !== null ? String(row[idx]).length : 0))
                    );
                    return { wch: Math.min(Math.max(maxLen + 2, 8), 40) };
                });
                ws['!cols'] = colWidths;

                const sheetName = sanitizeSheetName(userId);
                XLSX.utils.book_append_sheet(wb, ws, sheetName);
            });

            const filename = `借閱清單_全部_${dateStr}.xlsx`;
            XLSX.writeFile(wb, filename);
            this.showToast('已匯出單一檔案（多工作表）', 'success');
            return;
        }

        // 學生/訪客：只匯出自己的活頁簿
        const header = ['借閱編號', '書碼', '書名', '借閱者', '借閱日期'];
        const rows = records.map(r => {
            const borrowDate = new Date(r.borrowDate);
            return [
                r.id,
                r.bookId,
                r.bookTitle,
                r.userId,
                borrowDate.toLocaleDateString('zh-TW')
            ];
        });

        const aoa = [header, ...rows];
        const ws = XLSX.utils.aoa_to_sheet(aoa);
        const colWidths = header.map((h, idx) => {
            const maxLen = Math.max(
                h.length,
                ...rows.map(row => (row[idx] !== undefined && row[idx] !== null ? String(row[idx]).length : 0))
            );
            return { wch: Math.min(Math.max(maxLen + 2, 8), 40) };
        });
        ws['!cols'] = colWidths;

        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, '借閱清單');
        const dateStr = new Date().toISOString().slice(0, 10);
        const filename = `借閱清單_${this.currentUser.username}_${dateStr}.xlsx`;
        XLSX.writeFile(wb, filename);
        this.showToast('已匯出借閱清單', 'success');
    }

    // 顯示搜尋封面模態框
    showFetchCoversModal() {
        if (!this.requireAdmin('一鍵搜尋封面')) return;
        
        const modal = document.getElementById('fetch-covers-modal');
        if (modal) {
            modal.style.display = 'block';
            // 重置表單
            document.getElementById('fetch-covers-form').reset();
            document.getElementById('range-options').style.display = 'none';
            document.getElementById('genre-options').style.display = 'none';
        }
    }

    // 處理搜尋封面表單提交
    async handleFetchCovers(e) {
        e.preventDefault();
        if (!this.requireAdmin('一鍵搜尋封面')) return;

        const rangeType = document.getElementById('fetch-range').value;
        const fetchCovers = document.getElementById('fetch-covers').checked;
        const fetchAuthors = document.getElementById('fetch-authors').checked;

        if (!fetchCovers && !fetchAuthors) {
            this.showToast('請至少選擇一種搜尋類型', 'error');
            return;
        }

        // 根據範圍類型篩選書籍
        let searchQueue = [];
        
        if (rangeType === 'all') {
            searchQueue = this.books.filter(book => 
                (fetchCovers && !book.coverUrl) || 
                (fetchAuthors && !book.author)
            );
        } else if (rangeType === 'range') {
            const startCode = document.getElementById('range-start').value.trim().toUpperCase();
            const endCode = document.getElementById('range-end').value.trim().toUpperCase();
            
            if (!startCode || !endCode) {
                this.showToast('請輸入起始和結束書碼', 'error');
                return;
            }

            searchQueue = this.books.filter(book => {
                const bookCode = book.id.toUpperCase();
                const inRange = bookCode >= startCode && bookCode <= endCode;
                const needsUpdate = (fetchCovers && !book.coverUrl) || (fetchAuthors && !book.author);
                return inRange && needsUpdate;
            });
        } else if (rangeType === 'genre') {
            const genre = document.getElementById('fetch-genre').value;
            searchQueue = this.books.filter(book => 
                book.genre === genre && 
                ((fetchCovers && !book.coverUrl) || (fetchAuthors && !book.author))
            );
        }

        if (searchQueue.length === 0) {
            this.showToast('在指定範圍內沒有需要更新的書籍', 'info');
            return;
        }

        // 關閉設定模態框，打開進度模態框
        document.getElementById('fetch-covers-modal').style.display = 'none';
        this.showSearchProgressModal();

        // 開始搜尋
        await this.startSearchProcess(searchQueue, fetchCovers, fetchAuthors);
    }

    // 切換搜尋選項顯示
    toggleFetchOptions(rangeType) {
        const rangeOptions = document.getElementById('range-options');
        const genreOptions = document.getElementById('genre-options');

        rangeOptions.style.display = rangeType === 'range' ? 'block' : 'none';
        genreOptions.style.display = rangeType === 'genre' ? 'block' : 'none';
    }

    // 顯示搜尋進度模態框
    showSearchProgressModal() {
        const modal = document.getElementById('search-progress-modal');
        if (modal) {
            modal.style.display = 'block';
            // 重置進度顯示
            this.updateProgressDisplay();
        }
    }

    // 開始搜尋處理
    async startSearchProcess(searchQueue, fetchCovers, fetchAuthors) {
        this.searchState = {
            isRunning: true,
            isPaused: false,
            shouldStop: false,
            currentIndex: 0,
            totalBooks: searchQueue.length,
            successCount: 0,
            failCount: 0,
            searchQueue: searchQueue,
            fetchCovers: fetchCovers,
            fetchAuthors: fetchAuthors
        };

        this.updateProgressDisplay();

        while (this.searchState.currentIndex < this.searchState.searchQueue.length && !this.searchState.shouldStop) {
            // 檢查是否暫停
            while (this.searchState.isPaused && !this.searchState.shouldStop) {
                await this.sleep(100);
            }

            if (this.searchState.shouldStop) break;

            const book = this.searchState.searchQueue[this.searchState.currentIndex];
            
            try {
                // 更新目前處理的書籍名稱
                document.getElementById('current-book-title').textContent = book.title;

                let success = false;

                // 搜尋封面
                if (this.searchState.fetchCovers && !book.coverUrl) {
                    const coverUrl = await this.searchBookCover(book.title, book.author);
                    if (coverUrl) {
                        book.coverUrl = coverUrl;
                        success = true;
                    }
                }

                // 搜尋作者
                if (this.searchState.fetchAuthors && !book.author) {
                    const author = await this.searchBookAuthor(book.title);
                    if (author) {
                        book.author = author;
                        success = true;
                    }
                }

                if (success) {
                    this.searchState.successCount++;
                } else {
                    this.searchState.failCount++;
                }

                this.searchState.currentIndex++;
                this.updateProgressDisplay();

                // 避免請求過於頻繁
                await this.sleep(1000);

            } catch (error) {
                console.error(`搜尋時發生錯誤 (${book.title}):`, error);
                this.searchState.failCount++;
                this.searchState.currentIndex++;
                this.updateProgressDisplay();
            }
        }

        // 搜尋完成
        this.finishSearchProcess();
    }

    // 更新進度顯示
    updateProgressDisplay() {
        const progress = (this.searchState.currentIndex / this.searchState.totalBooks) * 100;
        
        document.getElementById('progress-count').textContent = this.searchState.currentIndex;
        document.getElementById('progress-total').textContent = this.searchState.totalBooks;
        document.getElementById('success-count').textContent = this.searchState.successCount;
        document.getElementById('fail-count').textContent = this.searchState.failCount;
        document.getElementById('progress-fill').style.width = `${progress}%`;
    }

    // 暫停搜尋
    pauseSearch() {
        this.searchState.isPaused = true;
        document.getElementById('pause-search-btn').style.display = 'none';
        document.getElementById('resume-search-btn').style.display = 'inline-flex';
        this.showToast('搜尋已暫停', 'info');
    }

    // 繼續搜尋
    resumeSearch() {
        this.searchState.isPaused = false;
        document.getElementById('pause-search-btn').style.display = 'inline-flex';
        document.getElementById('resume-search-btn').style.display = 'none';
        this.showToast('搜尋已繼續', 'info');
    }

    // 停止搜尋
    stopSearch() {
        this.searchState.shouldStop = true;
        this.showToast('搜尋已停止', 'warning');
    }

    // 完成搜尋處理
    finishSearchProcess() {
        this.searchState.isRunning = false;
        
        // 儲存資料並更新顯示
        this.saveData();
        this.renderBooks();
        
        // 關閉進度模態框
        document.getElementById('search-progress-modal').style.display = 'none';
        
        // 顯示結果
        this.showToast(`搜尋完成！成功: ${this.searchState.successCount}, 失敗: ${this.searchState.failCount}`, 'success');
        
        // 自動同步到 Google Sheets
        this.scheduleAutoSync();
        this.pushToGoogleSheetsNow();
    }

    // 搜尋書籍作者
    async searchBookAuthor(title) {
        try {
            const query = encodeURIComponent(title);
            const apiUrl = `https://www.googleapis.com/books/v1/volumes?q=${query}&maxResults=1&langRestrict=zh`;
            
            const response = await fetch(apiUrl);
            if (!response.ok) return null;
            
            const data = await response.json();
            
            if (data.items && data.items.length > 0) {
                const book = data.items[0];
                const authors = book.volumeInfo.authors;
                
                if (authors && authors.length > 0) {
                    return authors.join(', ');
                }
            }
            
            return null;
        } catch (error) {
            console.error('搜尋作者時發生錯誤:', error);
            return null;
        }
    }

    // 搜尋單本書籍封面
    async searchBookCover(title, author = '') {
        try {
            // 建構搜尋查詢
            let query = title;
            if (author) {
                query += ` ${author}`;
            }

            // 使用 Google Books API
            const apiUrl = `https://www.googleapis.com/books/v1/volumes?q=${encodeURIComponent(query)}&maxResults=1&langRestrict=zh`;
            
            const response = await fetch(apiUrl);
            if (!response.ok) return null;
            
            const data = await response.json();
            
            if (data.items && data.items.length > 0) {
                const book = data.items[0];
                const imageLinks = book.volumeInfo.imageLinks;
                
                if (imageLinks) {
                    // 優先使用大圖，如果沒有則使用中圖或縮圖
                    return imageLinks.extraLarge || 
                           imageLinks.large || 
                           imageLinks.medium || 
                           imageLinks.thumbnail || 
                           imageLinks.smallThumbnail;
                }
            }
            
            return null;
        } catch (error) {
            console.error('搜尋封面時發生錯誤:', error);
            return null;
        }
    }

    // 延遲函數
    sleep(ms) {
        return new Promise(resolve => setTimeout(resolve, ms));
    }

    // 顯示載入指示器
    showLoadingIndicator(show) {
        let indicator = document.getElementById('loading-indicator');
        
        if (!indicator) {
            indicator = document.createElement('div');
            indicator.id = 'loading-indicator';
            indicator.innerHTML = `
                <div class="loading-overlay">
                    <div class="loading-spinner">
                        <i class="fas fa-spinner fa-spin"></i>
                        <div class="loading-text">處理中...</div>
                    </div>
                </div>
            `;
            
            // 添加載入指示器的樣式
            const style = document.createElement('style');
            style.textContent = `
                .loading-overlay {
                    position: fixed;
                    top: 0;
                    left: 0;
                    width: 100%;
                    height: 100%;
                    background: rgba(0, 0, 0, 0.5);
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    z-index: 9999;
                }
                
                .loading-spinner {
                    background: white;
                    padding: 30px;
                    border-radius: 12px;
                    text-align: center;
                    box-shadow: 0 8px 30px rgba(0, 0, 0, 0.3);
                }
                
                .loading-spinner i {
                    font-size: 2rem;
                    color: #667eea;
                    margin-bottom: 15px;
                }
                
                .loading-text {
                    font-size: 1.1rem;
                    color: #4a5568;
                    font-weight: 600;
                }
            `;
            
            document.head.appendChild(style);
            document.body.appendChild(indicator);
        }
        
        indicator.style.display = show ? 'flex' : 'none';
    }

    // 搜尋書籍資訊（當找不到書籍時使用）
    async searchBookInfo(searchTerm, preferredSource = null) {
        if (!searchTerm || searchTerm.trim() === '') {
            this.showToast('請輸入書名進行搜尋', 'error');
            return;
        }

        try {
            this.showToast('正在搜尋書籍資訊...', 'info');
            this.showLoadingIndicator(true);

            let results = [];

            // 如果指定了特定書庫，直接使用手動搜尋選項
            if (preferredSource === 'bookscom' || preferredSource === 'kingstone' || preferredSource === 'eslite') {
                this.showManualSearchOptions(searchTerm, []);
                return;
            }

            // 如果指定了多選搜尋，顯示多選介面
            if (preferredSource === 'multi') {
                this.showMultiSearchOptions(searchTerm);
                return;
            }

            // 先嘗試 Google Books API
            results = await this.searchFromGoogleBooks(searchTerm);
            
            // 如果 Google Books 沒有結果，直接提供書庫選擇
            if (results.length === 0) {
                this.showLoadingIndicator(false);
                this.showToast('Google Books 沒有找到資料，請選擇其他書庫', 'info');
                this.showManualSearchOptions(searchTerm, []);
                return;
            }
            
            // 如果 Google Books 結果不足，嘗試 Open Library
            if (results.length < 3) {
                this.showToast('正在擴大搜尋範圍...', 'info');
                
                // 嘗試 Open Library
                const openLibraryResults = await this.searchFromOpenLibrary(searchTerm);
                results = [...results, ...openLibraryResults];
                
                // 如果結果仍然不足，提供手動搜尋選項
                if (results.length < 8) {
                    this.showManualSearchOptions(searchTerm, results);
                    return;
                }
            }

            if (results.length === 0) {
                this.showLoadingIndicator(false);
                this.showToast('找不到相關書籍資訊', 'warning');
                return;
            }

            // 顯示搜尋結果
            this.showBookSearchResults(results, searchTerm);

        } catch (error) {
            console.error('搜尋書籍資訊失敗:', error);
            this.showLoadingIndicator(false);
            this.showToast('搜尋失敗，請檢查網路連線', 'error');
        }
    }

    // 從 Google Books API 搜尋
    async searchFromGoogleBooks(searchTerm) {
        try {
            const query = encodeURIComponent(searchTerm.trim());
            const apiUrl = `https://www.googleapis.com/books/v1/volumes?q=${query}&maxResults=5&langRestrict=zh`;

            // 使用 API 隊列機制
            const data = await this.enqueueApiRequest(async () => {
                return await this.fetchWithRetry(apiUrl);
            });
            
            if (!data.items || data.items.length === 0) return [];

            return data.items.map(book => ({
                source: 'Google Books',
                volumeInfo: book.volumeInfo,
                id: book.id
            }));

        } catch (error) {
            console.error('Google Books 搜尋失敗:', error);
            this.handleApiError(error, 'Google Books 搜尋失敗');
            return [];
        }
    }

    // 從 Open Library API 搜尋
    async searchFromOpenLibrary(searchTerm) {
        try {
            const query = encodeURIComponent(searchTerm.trim());
            const apiUrl = `https://openlibrary.org/search.json?q=${query}&limit=5&language=chi`;

            // 使用 API 隊列機制
            const data = await this.enqueueApiRequest(async () => {
                return await this.fetchWithRetry(apiUrl);
            });
            
            if (!data.docs || data.docs.length === 0) return [];

            return data.docs.map(book => ({
                source: 'Open Library',
                volumeInfo: {
                    title: book.title,
                    authors: book.author_name || [],
                    publisher: book.publisher ? [book.publisher] : [],
                    publishedDate: book.first_publish_year ? book.first_publish_year.toString() : '',
                    description: book.first_sentence ? book.first_sentence.join(' ') : '無簡介',
                    industryIdentifiers: book.isbn ? [
                        { type: 'ISBN_13', identifier: book.isbn[0] },
                        { type: 'ISBN_10', identifier: book.isbn[0] }
                    ] : [],
                    imageLinks: book.cover_i ? {
                        thumbnail: `https://covers.openlibrary.org/b/id/${book.cover_i}-M.jpg`,
                        smallThumbnail: `https://covers.openlibrary.org/b/id/${book.cover_i}-S.jpg`,
                        medium: `https://covers.openlibrary.org/b/id/${book.cover_i}-M.jpg`,
                        large: `https://covers.openlibrary.org/b/id/${book.cover_i}-L.jpg`
                    } : null
                },
                id: book.key.replace('/works/', '')
            }));

        } catch (error) {
            console.error('Open Library 搜尋失敗:', error);
            this.handleApiError(error, 'Open Library 搜尋失敗');
            return [];
        }
    }

    // 從博客來搜尋（使用代理方式）
    async searchFromBooksCom(searchTerm) {
        try {
            // 由於CORS限制，我們使用博客來的搜尋API代理
            const query = encodeURIComponent(searchTerm.trim());
            const apiUrl = `https://search.books.com.tw/search/query/key/${query}/cat/all`;

            // 使用CORS代理服務
            const proxyUrl = `https://cors-anywhere.herokuapp.com/${apiUrl}`;
            
            const response = await fetch(proxyUrl, {
                headers: {
                    'X-Requested-With': 'XMLHttpRequest'
                }
            });
            
            if (!response.ok) return [];

            const html = await response.text();
            
            // 解析HTML提取書籍資訊
            const parser = new DOMParser();
            const doc = parser.parseFromString(html, 'text/html');
            
            const books = [];
            const bookElements = doc.querySelectorAll('.item');
            
            bookElements.forEach(element => {
                try {
                    const titleElement = element.querySelector('.title a');
                    const authorElement = element.querySelector('.author');
                    const imageElement = element.querySelector('img');
                    const publisherElement = element.querySelector('.publisher');
                    const yearElement = element.querySelector('.date');
                    
                    if (titleElement) {
                        const title = titleElement.textContent.trim();
                        const author = authorElement ? authorElement.textContent.trim() : '未知作者';
                        const coverUrl = imageElement ? imageElement.src || imageElement.getAttribute('data-src') : '';
                        const publisher = publisherElement ? publisherElement.textContent.trim() : '未知出版社';
                        const year = yearElement ? yearElement.textContent.trim().match(/\d{4}/)?.[0] || '未知年份' : '未知年份';
                        
                        books.push({
                            source: '博客來',
                            volumeInfo: {
                                title,
                                authors: [author],
                                publisher,
                                publishedDate: year,
                                description: '博客來書籍資料',
                                industryIdentifiers: [],
                                imageLinks: coverUrl ? {
                                    thumbnail: coverUrl,
                                    smallThumbnail: coverUrl
                                } : null
                            },
                            id: `bookscom_${books.length}`
                        });
                    }
                } catch (e) {
                    console.warn('解析博客來書籍資訊失敗:', e);
                }
            });
            
            return books.slice(0, 5); // 限制返回5本

        } catch (error) {
            console.error('博客來搜尋失敗:', error);
            return [];
        }
    }

    // 從金石堂搜尋（使用代理方式）
    async searchFromKingstone(searchTerm) {
        try {
            // 由於CORS限制，我們使用金石堂的搜尋API代理
            const query = encodeURIComponent(searchTerm.trim());
            const apiUrl = `https://www.kingstone.com.tw/search/search.aspx?searchkey=${query}`;

            // 使用CORS代理服務
            const proxyUrl = `https://cors-anywhere.herokuapp.com/${apiUrl}`;
            
            const response = await fetch(proxyUrl, {
                headers: {
                    'X-Requested-With': 'XMLHttpRequest'
                }
            });
            
            if (!response.ok) return [];

            const html = await response.text();
            
            // 解析HTML提取書籍資訊
            const parser = new DOMParser();
            const doc = parser.parseFromString(html, 'text/html');
            
            const books = [];
            const bookElements = doc.querySelectorAll('.pdbookbox');
            
            bookElements.forEach(element => {
                try {
                    const titleElement = element.querySelector('.title a');
                    const authorElement = element.querySelector('.author');
                    const imageElement = element.querySelector('img');
                    const publisherElement = element.querySelector('.publish');
                    
                    if (titleElement) {
                        const title = titleElement.textContent.trim();
                        const author = authorElement ? authorElement.textContent.trim() : '未知作者';
                        const coverUrl = imageElement ? imageElement.src || imageElement.getAttribute('data-src') : '';
                        const publisher = publisherElement ? publisherElement.textContent.trim() : '未知出版社';
                        const year = '未知年份';
                        
                        books.push({
                            source: '金石堂',
                            volumeInfo: {
                                title,
                                authors: [author],
                                publisher,
                                publishedDate: year,
                                description: '金石堂書籍資料',
                                industryIdentifiers: [],
                                imageLinks: coverUrl ? {
                                    thumbnail: coverUrl,
                                    smallThumbnail: coverUrl
                                } : null
                            },
                            id: `kingstone_${books.length}`
                        });
                    }
                } catch (e) {
                    console.warn('解析金石堂書籍資訊失敗:', e);
                }
            });
            
            return books.slice(0, 5); // 限制返回5本

        } catch (error) {
            console.error('金石堂搜尋失敗:', error);
            return [];
        }
    }

    // 顯示手動搜尋選項
    showManualSearchOptions(searchTerm, currentResults) {
        this.showLoadingIndicator(false);
        
        // 處理特殊字符，避免JavaScript語法錯誤
        const safeSearchTerm = searchTerm.replace(/'/g, "\\'").replace(/"/g, '\\"');

        const modal = document.createElement('div');
        modal.className = 'modal';
        modal.innerHTML = `
            <div class="modal-content" style="max-width: 600px;">
                <span class="close">&times;</span>
                <h2><i class="fas fa-search"></i> 選擇書庫搜尋</h2>
                <p>請選擇要搜尋的書庫，或使用自動搜尋：</p>
                
                <div class="search-source-buttons">
                    <button class="btn btn-primary" onclick="this.closest('.modal').remove(); library.searchBookInfo('${safeSearchTerm}', 'auto')">
                        <i class="fas fa-globe"></i> 自動搜尋
                    </button>
                    <button class="btn btn-info" onclick="this.closest('.modal').remove(); library.searchBookInfo('${safeSearchTerm}', 'multi')">
                        <i class="fas fa-check-square"></i> 多選搜尋
                    </button>
                    <button class="btn btn-success" onclick="this.closest('.modal').remove(); library.openBooksComSearch('${safeSearchTerm}')">
                        <i class="fas fa-book"></i> 博客來
                    </button>
                    <button class="btn btn-warning" onclick="this.closest('.modal').remove(); library.openKingstoneSearch('${safeSearchTerm}')">
                        <i class="fas fa-book-open"></i> 金石堂
                    </button>
                    <button class="btn btn-secondary" onclick="this.closest('.modal').remove(); library.openEsliteSearch('${safeSearchTerm}')">
                        <i class="fas fa-globe"></i> 誠品線上
                    </button>
                </div>
                
                <div class="search-source-info">
                    <h4><i class="fas fa-info-circle"></i> 書庫說明</h4>
                    <div class="source-grid">
                        <div class="source-item">
                            <strong>自動搜尋</strong>
                            <p>Google Books + Open Library，適合搜尋外文書籍</p>
                        </div>
                        <div class="source-item">
                            <strong>博客來</strong>
                            <p>台灣最大線上書店，中文書籍最齊全</p>
                        </div>
                        <div class="source-item">
                            <strong>金石堂</strong>
                            <p>知名連鎖書店，暢銷書豐富</p>
                        </div>
                        <div class="source-item">
                            <strong>誠品線上</strong>
                            <p>文化藝術書店，文學設計類豐富</p>
                        </div>
                    </div>
                </div>
                
                <div class="form-actions">
                    <button type="button" class="btn btn-outline" onclick="this.closest('.modal').remove()">
                        <i class="fas fa-times"></i> 取消
                    </button>
                    <button type="button" class="btn btn-success" onclick="library.openBooksComSearch('${safeSearchTerm}')">
                        <i class="fas fa-external-link-alt"></i> 測試博客來
                    </button>
                </div>
            </div>
        `;

        document.body.appendChild(modal);
        modal.style.display = 'block';

        // 設置關閉事件
        modal.querySelector('.close').onclick = () => modal.remove();
        modal.onclick = (e) => {
            if (e.target === modal) modal.remove();
        };
    }

    // 開啟博客來搜尋
    openBooksComSearch(searchTerm) {
        const query = encodeURIComponent(searchTerm.trim());
        const url = `https://search.books.com.tw/search/query/key/${query}/cat/all`;
        window.open(url, '_blank');
        this.showToast('已開啟博客來搜尋頁面', 'info');
    }

    // 開啟金石堂搜尋
    openKingstoneSearch(searchTerm) {
        const query = encodeURIComponent(searchTerm.trim());
        const url = `https://www.kingstone.com.tw/search/search.aspx?searchkey=${query}`;
        window.open(url, '_blank');
        this.showToast('已開啟金石堂搜尋頁面', 'info');
    }

    // 開啟誠品搜尋
    openEsliteSearch(searchTerm) {
        const query = encodeURIComponent(searchTerm.trim());
        const url = `https://www.eslite.com/Search.aspx?keyword=${query}`;
        window.open(url, '_blank');
        this.showToast('已開啟誠品搜尋頁面', 'info');
    }

    // 顯示多選搜尋選項
    showMultiSearchOptions(searchTerm) {
        this.showLoadingIndicator(false);
        
        // 處理特殊字符，避免JavaScript語法錯誤
        const safeSearchTerm = searchTerm.replace(/'/g, "\\'").replace(/"/g, '\\"');

        const modal = document.createElement('div');
        modal.className = 'modal';
        modal.innerHTML = `
            <div class="modal-content" style="max-width: 700px;">
                <span class="close">&times;</span>
                <h2><i class="fas fa-search"></i> 多選書庫搜尋</h2>
                <p>選擇要搜尋的書庫，可以同時開啟多個書庫：</p>
                
                <div class="multi-search-grid">
                    <div class="search-source-item">
                        <label class="checkbox-container">
                            <input type="checkbox" id="google-books" checked>
                            <span class="checkmark"></span>
                            <div class="source-info">
                                <strong>🌐 Google Books</strong>
                                <p>國際書籍資料庫，外文書籍豐富</p>
                            </div>
                        </label>
                    </div>
                    
                    <div class="search-source-item">
                        <label class="checkbox-container">
                            <input type="checkbox" id="open-library" checked>
                            <span class="checkmark"></span>
                            <div class="source-info">
                                <strong>📚 Open Library</strong>
                                <p>開放書籍資料庫，書籍數量龐大</p>
                            </div>
                        </label>
                    </div>
                    
                    <div class="search-source-item">
                        <label class="checkbox-container">
                            <input type="checkbox" id="books-com">
                            <span class="checkmark"></span>
                            <div class="source-info">
                                <strong>📖 博客來</strong>
                                <p>台灣最大線上書店，中文書籍最齊全</p>
                            </div>
                        </label>
                    </div>
                    
                    <div class="search-source-item">
                        <label class="checkbox-container">
                            <input type="checkbox" id="kingstone">
                            <span class="checkmark"></span>
                            <div class="source-info">
                                <strong>📕 金石堂</strong>
                                <p>知名連鎖書店，暢銷書豐富</p>
                            </div>
                        </label>
                    </div>
                    
                    <div class="search-source-item">
                        <label class="checkbox-container">
                            <input type="checkbox" id="eslite">
                            <span class="checkmark"></span>
                            <div class="source-info">
                                <strong>🎨 誠品線上</strong>
                                <p>文化藝術書店，文學設計類豐富</p>
                            </div>
                        </label>
                    </div>
                </div>
                
                <div class="search-actions">
                    <button class="btn btn-primary" onclick="library.executeMultiSearch('${safeSearchTerm}')">
                        <i class="fas fa-search"></i> 開始搜尋
                    </button>
                    <button class="btn btn-success" onclick="library.selectAllSources()">
                        <i class="fas fa-check-square"></i> 全選
                    </button>
                    <button class="btn btn-outline" onclick="library.deselectAllSources()">
                        <i class="fas fa-square"></i> 取消全選
                    </button>
                </div>
                
                <div class="form-actions">
                    <button type="button" class="btn btn-outline" onclick="this.closest('.modal').remove()">
                        <i class="fas fa-times"></i> 取消
                    </button>
                </div>
            </div>
        `;

        document.body.appendChild(modal);
        modal.style.display = 'block';

        // 設置關閉事件
        modal.querySelector('.close').onclick = () => modal.remove();
        modal.onclick = (e) => {
            if (e.target === modal) modal.remove();
        };
    }

    // 執行多選搜尋
    async executeMultiSearch(searchTerm) {
        const sources = {
            'google-books': document.getElementById('google-books').checked,
            'open-library': document.getElementById('open-library').checked,
            'books-com': document.getElementById('books-com').checked,
            'kingstone': document.getElementById('kingstone').checked,
            'eslite': document.getElementById('eslite').checked
        };

        // 關閉多選介面
        document.querySelector('.modal').remove();

        // 開啟選中的書庫
        if (sources['books-com']) {
            this.openBooksComSearch(searchTerm);
        }
        if (sources['kingstone']) {
            this.openKingstoneSearch(searchTerm);
        }
        if (sources['eslite']) {
            this.openEsliteSearch(searchTerm);
        }

        // 對於API書庫，執行搜尋並顯示結果
        let apiResults = [];
        
        if (sources['google-books']) {
            this.showToast('正在搜尋 Google Books...', 'info');
            const googleResults = await this.searchFromGoogleBooks(searchTerm);
            apiResults = [...apiResults, ...googleResults];
        }
        
        if (sources['open-library']) {
            this.showToast('正在搜尋 Open Library...', 'info');
            const openLibraryResults = await this.searchFromOpenLibrary(searchTerm);
            apiResults = [...apiResults, ...openLibraryResults];
        }

        // 如果有API結果，顯示搜尋結果
        if (apiResults.length > 0) {
            this.showBookSearchResults(apiResults, searchTerm);
        } else if (!sources['books-com'] && !sources['kingstone'] && !sources['eslite']) {
            this.showToast('請至少選擇一個書庫', 'warning');
        } else {
            this.showToast('已開啟選中的書庫網站', 'info');
        }
    }

    // 全選所有書庫
    selectAllSources() {
        const checkboxes = document.querySelectorAll('.multi-search-grid input[type="checkbox"]');
        checkboxes.forEach(checkbox => checkbox.checked = true);
    }

    // 取消全選所有書庫
    deselectAllSources() {
        const checkboxes = document.querySelectorAll('.multi-search-grid input[type="checkbox"]');
        checkboxes.forEach(checkbox => checkbox.checked = false);
    }

    // 顯示書籍搜尋結果
    showBookSearchResults(books, searchTerm) {
        this.showLoadingIndicator(false);
        
        // 保存搜尋結果供其他函數使用
        this.searchResults = books;

        const modal = document.createElement('div');
        modal.className = 'modal';
        modal.innerHTML = `
            <div class="modal-content" style="max-width: 800px;">
                <span class="close">&times;</span>
                <h2><i class="fas fa-search"></i> 書籍搜尋結果</h2>
                <div class="search-results">
                    ${books.map((book, index) => {
                        const info = book.volumeInfo;
                        const coverUrl = info.imageLinks?.thumbnail || info.imageLinks?.smallThumbnail || '';
                        const authors = info.authors ? info.authors.join(', ') : '未知作者';
                        const publisher = info.publisher || '未知出版社';
                        const publishedDate = info.publishedDate ? info.publishedDate.substring(0, 4) : '未知年份';
                        const isbn = info.industryIdentifiers?.find(id => id.type === 'ISBN_13')?.identifier || 
                                     info.industryIdentifiers?.find(id => id.type === 'ISBN_10')?.identifier || '';
                        const description = info.description ? info.description.substring(0, 200) + '...' : '無簡介';

                        return `
                            <div class="search-result-item">
                                <div class="search-result-cover">
                                    ${coverUrl ? `<img src="${coverUrl}" alt="${info.title}" onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
                                    <div class="search-result-cover-placeholder" style="display: none;">
                                        <i class="fas fa-book"></i>
                                    </div>` : `
                                    <div class="search-result-cover-placeholder">
                                        <i class="fas fa-book"></i>
                                    </div>`}
                                </div>
                                <div class="search-result-info">
                                    <div class="search-result-header">
                                        <h3 class="search-result-title">${info.title}</h3>
                                        <span class="search-result-source ${book.source === 'Google Books' ? 'google-books' : book.source === 'Open Library' ? 'open-library' : book.source === '博客來' ? 'books-com' : book.source === '金石堂' ? 'kingstone' : ''}">${book.source || '未知來源'}</span>
                                    </div>
                                    <div class="search-result-details">
                                        <p><strong>作者：</strong>${authors}</p>
                                        <p><strong>出版社：</strong>${publisher}</p>
                                        <p><strong>出版年份：</strong>${publishedDate}</p>
                                        ${isbn ? `<p><strong>ISBN：</strong>${isbn}</p>` : ''}
                                        <p><strong>簡介：</strong>${description}</p>
                                    </div>
                                    <div class="search-result-actions">
                                        <button class="btn btn-primary btn-sm" onclick="library.copyBookInfo(${index})">
                                            <i class="fas fa-copy"></i> 複製資訊
                                        </button>
                                        ${this.isAdminUser() ? `
                                        <button class="btn btn-success btn-sm" onclick="library.addBookFromSearch(${index})">
                                            <i class="fas fa-plus"></i> 新增到館藏
                                        </button>` : ''}
                                    </div>
                                </div>
                            </div>
                        `;
                    }).join('')}
                </div>
                <div class="form-actions">
                    <button type="button" class="btn btn-outline" onclick="this.closest('.modal').remove()">
                        <i class="fas fa-times"></i> 關閉
                    </button>
                </div>
            </div>
        `;

        // 儲存搜尋結果供後續使用
        this.searchResults = books;
        this.searchTerm = searchTerm;

        document.body.appendChild(modal);
        modal.style.display = 'block';

        // 設置關閉事件
        modal.querySelector('.close').addEventListener('click', () => modal.remove());
        modal.addEventListener('click', (e) => {
            if (e.target === modal) modal.remove();
        });
    }

    // 複製書籍資訊
    copyBookInfo(index) {
        const book = this.searchResults[index];
        const info = book.volumeInfo;
        
        const authors = info.authors ? info.authors.join(', ') : '未知作者';
        const publisher = info.publisher || '未知出版社';
        const publishedDate = info.publishedDate ? info.publishedDate.substring(0, 4) : '未知年份';
        const isbn = info.industryIdentifiers?.find(id => id.type === 'ISBN_13')?.identifier || 
                     info.industryIdentifiers?.find(id => id.type === 'ISBN_10')?.identifier || '';
        const coverUrl = info.imageLinks?.thumbnail || info.imageLinks?.smallThumbnail || '';

        // 檢查編輯模態框是否開啟
        const editModal = document.getElementById('edit-book-modal');
        const isEditModalOpen = editModal && editModal.style.display === 'block';

        if (isEditModalOpen) {
            // 如果編輯模態框開啟，直接填入表單
            this.fillEditFormWithBookInfo(info.title, authors, coverUrl, publishedDate);
            this.showToast('書籍資訊已填入編輯表單', 'success');
        } else {
            // 否則複製到剪貼簿
            const bookInfo = `書名：${info.title}
作者：${authors}
出版社：${publisher}
出版年份：${publishedDate}
${isbn ? `ISBN：${isbn}` : ''}
封面圖片：${coverUrl}`;

            // 複製到剪貼簿
            navigator.clipboard.writeText(bookInfo).then(() => {
                this.showToast('書籍資訊已複製到剪貼簿', 'success');
            }).catch(() => {
                // 如果剪貼簿 API 失敗，使用傳統方法
                const textArea = document.createElement('textarea');
                textArea.value = bookInfo;
                document.body.appendChild(textArea);
                textArea.select();
                document.execCommand('copy');
                document.body.removeChild(textArea);
                this.showToast('書籍資訊已複製到剪貼簿', 'success');
            });
        }
    }

    // 將書籍資訊填入編輯表單
    fillEditFormWithBookInfo(title, author, coverUrl, year) {
        const titleInput = document.getElementById('edit-book-title');
        const authorInput = document.getElementById('edit-book-author');
        const coverInput = document.getElementById('edit-book-cover-url');
        const yearInput = document.getElementById('edit-book-year');

        // 只填入空白的欄位
        if (titleInput && !titleInput.value.trim()) {
            titleInput.value = title;
        }
        if (authorInput && !authorInput.value.trim()) {
            authorInput.value = author;
        }
        if (coverInput && !coverInput.value.trim()) {
            coverInput.value = coverUrl;
        }
        if (yearInput && yearInput.value === this.settings.defaultYear) {
            yearInput.value = year;
        }
    }

    // 從搜尋結果新增書籍
    addBookFromSearch(index) {
        const book = this.searchResults[index];
        const info = book.volumeInfo;
        
        // 預填新增書籍表單
        const suggestedId = this.suggestNextBookId();
        const idEl = document.getElementById('book-id');
        if (idEl && !idEl.value.trim()) idEl.value = suggestedId;
        document.getElementById('book-title').value = info.title || '';
        document.getElementById('book-author').value = info.authors ? info.authors.join(', ') : '';
        document.getElementById('book-year').value = info.publishedDate ? info.publishedDate.substring(0, 4) : new Date().getFullYear();
        document.getElementById('book-cover-url').value = info.imageLinks?.thumbnail || info.imageLinks?.smallThumbnail || '';
        
        // 關閉搜尋結果模態框
        document.querySelector('.modal').remove();
        
        // 顯示新增書籍模態框
        this.showAddBookModal();
        
        this.showToast('已將書籍資訊填入新增表單', 'success');
    }

}

// 初始化系統
const library = new LibrarySystem();

// 全域函數（供HTML調用）
window.library = library;
